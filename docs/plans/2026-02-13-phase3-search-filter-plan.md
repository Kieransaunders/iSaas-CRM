# Phase 3: Search & Filtering — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make it fast to find any deal, contact, or company via a global Cmd-K command palette and per-list client-side filter bars.

**Architecture:** A single Convex query `globalSearch(query)` performs server-side prefix matching across deals (title), contacts (firstName), and companies (name) -- returning top 5 per entity type for the Cmd-K palette. Per-list filtering is done entirely client-side using `useMemo` on the already-fetched `listDeals`/`listContacts`/`listCompanies` data (sufficient for small teams <1000 records). The `CommandPalette` component is rendered once in `MainLayout` and uses React context/state to open entity detail modals from anywhere.

**Tech Stack:** Convex queries (server search), shadcn/ui `CommandDialog` (cmdk), React `useMemo` (client filtering), `lucide-react` icons, existing `Select`/`Input`/`Badge` components.

---

### Task 1: Backend — `globalSearch` query

**Files:**
- Create: `convex/crm/search.ts`

**Step 1:** Create the `globalSearch` query that searches deals, contacts, and companies by prefix match.

```ts
// convex/crm/search.ts
import { v } from 'convex/values';
import { query } from '../_generated/server';
import { requireCrmUser } from './authz';

export const globalSearch = query({
  args: {
    query: v.string(),
  },
  handler: async (ctx, args) => {
    const { orgId } = await requireCrmUser(ctx);

    const searchQuery = args.query.trim().toLowerCase();
    if (searchQuery.length === 0) {
      return { deals: [], contacts: [], companies: [] };
    }

    // Fetch all entities for this org (small team assumption: <1000 records per type)
    const [allDeals, allContacts, allCompanies] = await Promise.all([
      ctx.db
        .query('deals')
        .withIndex('by_org', (q) => q.eq('orgId', orgId))
        .collect(),
      ctx.db
        .query('contacts')
        .withIndex('by_org', (q) => q.eq('orgId', orgId))
        .collect(),
      ctx.db
        .query('companies')
        .withIndex('by_org', (q) => q.eq('orgId', orgId))
        .collect(),
    ]);

    // Prefix match on title/name fields, return top 5 per type
    const deals = allDeals
      .filter((d) => d.title.toLowerCase().includes(searchQuery))
      .slice(0, 5)
      .map((d) => ({ _id: d._id, title: d.title, value: d.value, status: d.status }));

    const contacts = allContacts
      .filter((c) => {
        const fullName = `${c.firstName} ${c.lastName ?? ''}`.toLowerCase();
        return fullName.includes(searchQuery) || (c.email?.toLowerCase().includes(searchQuery) ?? false);
      })
      .slice(0, 5)
      .map((c) => ({
        _id: c._id,
        firstName: c.firstName,
        lastName: c.lastName,
        email: c.email,
      }));

    const companies = allCompanies
      .filter((c) => c.name.toLowerCase().includes(searchQuery))
      .slice(0, 5)
      .map((c) => ({ _id: c._id, name: c.name, industry: c.industry }));

    return { deals, contacts, companies };
  },
});
```

**Step 2:** Verify the file compiles by checking types.

```bash
npx convex typecheck
```

**Step 3:** Commit.

```bash
git add convex/crm/search.ts
git commit -m "feat: add globalSearch query for Cmd-K command palette

Searches deals by title, contacts by name/email, and companies by name.
Returns top 5 matches per entity type, scoped to the user's org."
```

---

### Task 2: Install shadcn Command component

**Files:**
- Create: `src/components/ui/command.tsx` (auto-generated by shadcn CLI)

**Step 1:** The `command.tsx` component does not currently exist. Install it via shadcn CLI. This will also install `cmdk` as a dependency.

```bash
npx shadcn@latest add command
```

This creates `src/components/ui/command.tsx` which exports `Command`, `CommandDialog`, `CommandInput`, `CommandList`, `CommandEmpty`, `CommandGroup`, `CommandItem`, `CommandSeparator`, etc.

**Step 2:** Verify the component was installed and the file exists.

```bash
ls src/components/ui/command.tsx
cat package.json | grep cmdk
```

Confirm `cmdk` appears in `dependencies` and the file exists.

**Step 3:** Commit.

```bash
git add src/components/ui/command.tsx package.json pnpm-lock.yaml
git commit -m "chore: install shadcn command component for Cmd-K palette"
```

---

### Task 3: Create `CommandPalette` component

**Files:**
- Create: `src/components/crm/command-palette.tsx`

**Step 1:** Create the command palette component that uses shadcn `CommandDialog`, calls `globalSearch`, and allows navigating to entities.

```tsx
// src/components/crm/command-palette.tsx
import { useCallback, useEffect, useState } from 'react';
import { useQuery } from 'convex/react';
import { Building2, CircleDollarSign, Search, User } from 'lucide-react';
import { api } from '../../../convex/_generated/api';
import type { Id } from '../../../convex/_generated/dataModel';
import {
  CommandDialog,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
  CommandSeparator,
} from '@/components/ui/command';

type EntitySelection =
  | { type: 'deal'; id: Id<'deals'> }
  | { type: 'contact'; id: Id<'contacts'> }
  | { type: 'company'; id: Id<'companies'> };

type CommandPaletteProps = {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSelect: (selection: EntitySelection) => void;
};

export type { EntitySelection };

export function CommandPalette({ open, onOpenChange, onSelect }: CommandPaletteProps) {
  const [searchQuery, setSearchQuery] = useState('');

  // Debounce: only search after user types at least 1 character
  const results = useQuery(
    api.crm.search.globalSearch,
    searchQuery.trim().length > 0 ? { query: searchQuery.trim() } : 'skip',
  );

  // Reset search when dialog closes
  useEffect(() => {
    if (!open) {
      setSearchQuery('');
    }
  }, [open]);

  const handleSelect = useCallback(
    (selection: EntitySelection) => {
      onSelect(selection);
      onOpenChange(false);
    },
    [onSelect, onOpenChange],
  );

  const hasResults =
    results &&
    (results.deals.length > 0 || results.contacts.length > 0 || results.companies.length > 0);

  return (
    <CommandDialog open={open} onOpenChange={onOpenChange}>
      <CommandInput
        placeholder="Search deals, contacts, companies..."
        value={searchQuery}
        onValueChange={setSearchQuery}
      />
      <CommandList>
        <CommandEmpty>
          {searchQuery.trim().length === 0
            ? 'Start typing to search...'
            : 'No results found.'}
        </CommandEmpty>

        {results && results.deals.length > 0 && (
          <CommandGroup heading="Deals">
            {results.deals.map((deal) => (
              <CommandItem
                key={deal._id}
                value={`deal-${deal._id}-${deal.title}`}
                onSelect={() => handleSelect({ type: 'deal', id: deal._id })}
              >
                <CircleDollarSign className="mr-2 h-4 w-4 text-muted-foreground" />
                <span className="flex-1">{deal.title}</span>
                {deal.value != null && (
                  <span className="text-xs text-muted-foreground">
                    ${deal.value.toLocaleString()}
                  </span>
                )}
              </CommandItem>
            ))}
          </CommandGroup>
        )}

        {results && results.deals.length > 0 && results.contacts.length > 0 && (
          <CommandSeparator />
        )}

        {results && results.contacts.length > 0 && (
          <CommandGroup heading="Contacts">
            {results.contacts.map((contact) => (
              <CommandItem
                key={contact._id}
                value={`contact-${contact._id}-${contact.firstName} ${contact.lastName ?? ''}`}
                onSelect={() => handleSelect({ type: 'contact', id: contact._id })}
              >
                <User className="mr-2 h-4 w-4 text-muted-foreground" />
                <span className="flex-1">
                  {contact.firstName}
                  {contact.lastName ? ` ${contact.lastName}` : ''}
                </span>
                {contact.email && (
                  <span className="text-xs text-muted-foreground">{contact.email}</span>
                )}
              </CommandItem>
            ))}
          </CommandGroup>
        )}

        {results && results.contacts.length > 0 && results.companies.length > 0 && (
          <CommandSeparator />
        )}

        {results && results.companies.length > 0 && (
          <CommandGroup heading="Companies">
            {results.companies.map((company) => (
              <CommandItem
                key={company._id}
                value={`company-${company._id}-${company.name}`}
                onSelect={() => handleSelect({ type: 'company', id: company._id })}
              >
                <Building2 className="mr-2 h-4 w-4 text-muted-foreground" />
                <span className="flex-1">{company.name}</span>
                {company.industry && (
                  <span className="text-xs text-muted-foreground">{company.industry}</span>
                )}
              </CommandItem>
            ))}
          </CommandGroup>
        )}
      </CommandList>
    </CommandDialog>
  );
}
```

**Step 2:** Verify the file has no TypeScript errors.

```bash
npx tsc --noEmit --pretty
```

**Step 3:** Commit.

```bash
git add src/components/crm/command-palette.tsx
git commit -m "feat: create CommandPalette component with global search

Uses shadcn CommandDialog with live search. Queries globalSearch backend,
groups results by entity type with icons. Calls onSelect with entity type and ID."
```

---

### Task 4: Wire CommandPalette into MainLayout with keyboard shortcut

**Files:**
- Modify: `src/components/layout/main-layout.tsx`
- Modify: `src/routes/_authenticated.tsx`

**Step 1:** Update `MainLayout` to include the `CommandPalette` component, the Cmd-K keyboard shortcut listener, and the detail modals needed to open search results. Add a `Search` button hint in the header, and render the three detail modals (deal, contact, company) at the layout level so any search result can be opened.

In `src/components/layout/main-layout.tsx`, add the following imports and state at the top of the `MainLayout` function:

```tsx
// src/components/layout/main-layout.tsx — full replacement
import { useCallback, useEffect, useState } from 'react';
import { useQuery } from 'convex/react';
import { Search } from 'lucide-react';
import { api } from '../../../convex/_generated/api';
import type { Id } from '../../../convex/_generated/dataModel';
import { AppSidebar } from './app-sidebar';
import { ImpersonationBanner } from './impersonation-banner';
import type { ReactNode } from 'react';
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb';
import { Separator } from '@/components/ui/separator';
import {
  SidebarInset,
  SidebarProvider,
  SidebarTrigger,
} from '@/components/ui/sidebar';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Button } from '@/components/ui/button';
import { CommandPalette, type EntitySelection } from '@/components/crm/command-palette';
import { DealDetailModal } from '@/components/crm/deal-detail-modal';
import { ContactDetailModal } from '@/components/crm/contact-detail-modal';
import { CompanyDetailModal } from '@/components/crm/company-detail-modal';

interface MainLayoutProps {
  children: ReactNode;
  breadcrumbs?: Array<{
    label: string;
    href?: string;
  }>;
}

export function MainLayout({ children, breadcrumbs }: MainLayoutProps) {
  const [commandOpen, setCommandOpen] = useState(false);
  const [selectedDealId, setSelectedDealId] = useState<Id<'deals'> | null>(null);
  const [selectedContactId, setSelectedContactId] = useState<Id<'contacts'> | null>(null);
  const [selectedCompanyId, setSelectedCompanyId] = useState<Id<'companies'> | null>(null);

  // Stages needed by DealDetailModal
  const defaultPipeline = useQuery(api.crm.pipelines.getDefaultPipeline);
  const stages = useQuery(
    api.crm.pipelines.listStagesByPipeline,
    defaultPipeline ? { pipelineId: defaultPipeline._id } : 'skip',
  );

  // Cmd-K / Ctrl-K keyboard shortcut
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        setCommandOpen((prev) => !prev);
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, []);

  const handleCommandSelect = useCallback((selection: EntitySelection) => {
    switch (selection.type) {
      case 'deal':
        setSelectedDealId(selection.id);
        break;
      case 'contact':
        setSelectedContactId(selection.id);
        break;
      case 'company':
        setSelectedCompanyId(selection.id);
        break;
    }
  }, []);

  return (
    <TooltipProvider>
      <SidebarProvider>
        {/* Skip to content link for accessibility */}
        <a
          href="#main-content"
          className="sr-only focus:not-sr-only focus:absolute focus:z-50 focus:p-4 focus:bg-primary focus:text-primary-foreground focus:rounded-md focus:top-4 focus:left-4"
        >
          Skip to main content
        </a>
        <AppSidebar />
        <SidebarInset id="main-content">
          <ImpersonationBanner />
          <header className="flex h-16 shrink-0 items-center gap-2 transition-[width,height] ease-linear group-has-[[data-collapsible=icon]]/sidebar-wrapper:h-12">
            <div className="flex items-center gap-2 px-4">
              <Tooltip>
                <TooltipTrigger asChild>
                  <SidebarTrigger className="-ml-1 hover:bg-accent" />
                </TooltipTrigger>
                <TooltipContent side="bottom">Toggle sidebar</TooltipContent>
              </Tooltip>
              <Separator orientation="vertical" className="mr-2 h-4" />
              {breadcrumbs && breadcrumbs.length > 0 && (
                <Breadcrumb>
                  <BreadcrumbList>
                    {breadcrumbs.map((crumb, index) => (
                      <BreadcrumbItem
                        key={crumb.label}
                        className={
                          index === breadcrumbs.length - 1
                            ? 'hidden md:block'
                            : ''
                        }
                      >
                        {index === breadcrumbs.length - 1 ? (
                          <BreadcrumbPage>{crumb.label}</BreadcrumbPage>
                        ) : (
                          <BreadcrumbLink href={crumb.href || '#'}>
                            {crumb.label}
                          </BreadcrumbLink>
                        )}
                        {index < breadcrumbs.length - 1 && (
                          <BreadcrumbSeparator className="hidden md:block" />
                        )}
                      </BreadcrumbItem>
                    ))}
                  </BreadcrumbList>
                </Breadcrumb>
              )}
            </div>
            <div className="ml-auto px-4">
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button
                    variant="outline"
                    size="sm"
                    className="gap-2 text-muted-foreground"
                    onClick={() => setCommandOpen(true)}
                  >
                    <Search className="h-4 w-4" />
                    <span className="hidden sm:inline">Search</span>
                    <kbd className="pointer-events-none hidden h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex">
                      <span className="text-xs">&#8984;</span>K
                    </kbd>
                  </Button>
                </TooltipTrigger>
                <TooltipContent>Search everything (Cmd+K)</TooltipContent>
              </Tooltip>
            </div>
          </header>
          <main className="flex flex-1 flex-col gap-4 p-4 pt-0">{children}</main>
        </SidebarInset>

        {/* Global Command Palette */}
        <CommandPalette
          open={commandOpen}
          onOpenChange={setCommandOpen}
          onSelect={handleCommandSelect}
        />

        {/* Global Detail Modals — opened from command palette search results */}
        <DealDetailModal
          dealId={selectedDealId}
          onClose={() => setSelectedDealId(null)}
          stages={stages ?? []}
        />
        <ContactDetailModal
          contactId={selectedContactId}
          onClose={() => setSelectedContactId(null)}
        />
        <CompanyDetailModal
          companyId={selectedCompanyId}
          onClose={() => setSelectedCompanyId(null)}
        />
      </SidebarProvider>
    </TooltipProvider>
  );
}
```

**Step 2:** Verify there are no TypeScript errors and that the Cmd-K button renders.

```bash
npx tsc --noEmit --pretty
```

Also verify manually: open the app, press Cmd-K, type a query. Clicking a result should open the appropriate detail modal.

**Step 3:** Commit.

```bash
git add src/components/layout/main-layout.tsx
git commit -m "feat: wire CommandPalette into MainLayout with Cmd-K shortcut

Adds search button in header with keyboard shortcut hint. Cmd-K/Ctrl-K
toggles the command palette. Selecting a result opens the entity's detail modal."
```

---

### Task 5: Add filter bar to contacts list

**Files:**
- Modify: `src/routes/_authenticated/contacts.tsx`

**Step 1:** Replace the contacts page with a version that has a filter bar above the table: search input (filters by name/email), company dropdown, and sort selector. All filtering is client-side using `useMemo`.

Replace the full contents of `src/routes/_authenticated/contacts.tsx`:

```tsx
// src/routes/_authenticated/contacts.tsx
import { createFileRoute } from '@tanstack/react-router';
import { useMutation, useQuery } from 'convex/react';
import { useMemo, useState } from 'react';
import { Search, X } from 'lucide-react';
import { api } from '../../../convex/_generated/api';
import type { Id } from '../../../convex/_generated/dataModel';
import type { FormEvent } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { ContactDetailModal } from '@/components/crm/contact-detail-modal';

export const Route = createFileRoute('/_authenticated/contacts')({
  component: ContactsPage,
});

type SortOption = 'name-asc' | 'name-desc' | 'created-desc' | 'created-asc';

function ContactsPage() {
  const contacts = useQuery(api.crm.contacts.listContacts);
  const companies = useQuery(api.crm.companies.listCompanies);
  const createContact = useMutation(api.crm.contacts.createContact);

  // Form state
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [email, setEmail] = useState('');
  const [selectedContactId, setSelectedContactId] = useState<Id<'contacts'> | null>(null);

  // Filter state
  const [searchQuery, setSearchQuery] = useState('');
  const [companyFilter, setCompanyFilter] = useState<string>('all');
  const [sortBy, setSortBy] = useState<SortOption>('created-desc');

  const onSubmit = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!firstName.trim()) return;

    await createContact({
      firstName: firstName.trim(),
      lastName: lastName.trim() || undefined,
      email: email.trim() || undefined,
    });

    setFirstName('');
    setLastName('');
    setEmail('');
  };

  // Client-side filtering and sorting
  const filteredContacts = useMemo(() => {
    if (!contacts) return [];

    let result = [...contacts];

    // Search filter: match name or email
    if (searchQuery.trim()) {
      const q = searchQuery.trim().toLowerCase();
      result = result.filter((c) => {
        const fullName = `${c.firstName} ${c.lastName ?? ''}`.toLowerCase();
        return fullName.includes(q) || (c.email?.toLowerCase().includes(q) ?? false);
      });
    }

    // Company filter
    if (companyFilter !== 'all') {
      if (companyFilter === 'none') {
        result = result.filter((c) => !c.companyId);
      } else {
        result = result.filter((c) => c.companyId === companyFilter);
      }
    }

    // Sorting
    result.sort((a, b) => {
      switch (sortBy) {
        case 'name-asc': {
          const nameA = `${a.firstName} ${a.lastName ?? ''}`.toLowerCase();
          const nameB = `${b.firstName} ${b.lastName ?? ''}`.toLowerCase();
          return nameA.localeCompare(nameB);
        }
        case 'name-desc': {
          const nameA = `${a.firstName} ${a.lastName ?? ''}`.toLowerCase();
          const nameB = `${b.firstName} ${b.lastName ?? ''}`.toLowerCase();
          return nameB.localeCompare(nameA);
        }
        case 'created-desc':
          return b.createdAt - a.createdAt;
        case 'created-asc':
          return a.createdAt - b.createdAt;
        default:
          return 0;
      }
    });

    return result;
  }, [contacts, searchQuery, companyFilter, sortBy]);

  const hasActiveFilters = searchQuery.trim().length > 0 || companyFilter !== 'all';

  const clearFilters = () => {
    setSearchQuery('');
    setCompanyFilter('all');
    setSortBy('created-desc');
  };

  return (
    <div className="flex flex-col gap-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Contacts</h1>
        <p className="text-muted-foreground">People linked to your deals and companies.</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>New contact</CardTitle>
        </CardHeader>
        <CardContent>
          <form className="grid gap-4 md:grid-cols-3" onSubmit={onSubmit}>
            <div className="space-y-2">
              <Label htmlFor="first-name">First name</Label>
              <Input id="first-name" value={firstName} onChange={(e) => setFirstName(e.target.value)} />
            </div>
            <div className="space-y-2">
              <Label htmlFor="last-name">Last name</Label>
              <Input id="last-name" value={lastName} onChange={(e) => setLastName(e.target.value)} />
            </div>
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} />
            </div>
            <div className="md:col-span-3">
              <Button type="submit" disabled={!firstName.trim()}>
                Create contact
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <CardTitle>All contacts</CardTitle>
              <CardDescription>
                {filteredContacts.length}
                {hasActiveFilters ? ` of ${contacts?.length ?? 0}` : ''} contacts
              </CardDescription>
            </div>
            {hasActiveFilters && (
              <Button variant="ghost" size="sm" onClick={clearFilters} className="gap-1">
                <X className="h-4 w-4" />
                Clear filters
              </Button>
            )}
          </div>
          {/* Filter bar */}
          <div className="flex flex-col gap-3 pt-2 sm:flex-row sm:items-center">
            <div className="relative flex-1 sm:max-w-xs">
              <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search name or email..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9"
              />
            </div>
            <Select value={companyFilter} onValueChange={setCompanyFilter}>
              <SelectTrigger className="w-full sm:w-[180px]">
                <SelectValue placeholder="All companies" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All companies</SelectItem>
                <SelectItem value="none">No company</SelectItem>
                {companies?.map((company) => (
                  <SelectItem key={company._id} value={company._id}>
                    {company.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Select value={sortBy} onValueChange={(v) => setSortBy(v as SortOption)}>
              <SelectTrigger className="w-full sm:w-[180px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="created-desc">Newest first</SelectItem>
                <SelectItem value="created-asc">Oldest first</SelectItem>
                <SelectItem value="name-asc">Name A-Z</SelectItem>
                <SelectItem value="name-desc">Name Z-A</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
        <CardContent>
          {!contacts || contacts.length === 0 ? (
            <p className="text-sm text-muted-foreground">No contacts yet.</p>
          ) : filteredContacts.length === 0 ? (
            <p className="text-sm text-muted-foreground">No contacts match your filters.</p>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Name</TableHead>
                  <TableHead>Email</TableHead>
                  <TableHead>Phone</TableHead>
                  <TableHead>Company</TableHead>
                  <TableHead>Created</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredContacts.map((contact) => (
                  <TableRow
                    key={contact._id}
                    className="cursor-pointer hover:bg-muted/50"
                    onClick={() => setSelectedContactId(contact._id)}
                  >
                    <TableCell className="font-medium">
                      {contact.firstName}{contact.lastName ? ` ${contact.lastName}` : ''}
                    </TableCell>
                    <TableCell>{contact.email ?? '\u2014'}</TableCell>
                    <TableCell>{contact.phone ?? '\u2014'}</TableCell>
                    <TableCell>
                      {contact.companyId
                        ? companies?.find((c) => c._id === contact.companyId)?.name ?? '\u2014'
                        : '\u2014'}
                    </TableCell>
                    <TableCell className="text-muted-foreground">
                      {new Date(contact.createdAt).toLocaleDateString()}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      <ContactDetailModal
        contactId={selectedContactId}
        onClose={() => setSelectedContactId(null)}
      />
    </div>
  );
}
```

**Step 2:** Verify it compiles and renders correctly.

```bash
npx tsc --noEmit --pretty
```

Manually test: visit `/contacts`, type in search, select a company from the dropdown, change sort order. Verify counts update.

**Step 3:** Commit.

```bash
git add src/routes/_authenticated/contacts.tsx
git commit -m "feat: add filter bar to contacts list page

Adds search by name/email, company dropdown filter, and sort selector.
Filtering is client-side via useMemo. Shows filtered count vs total."
```

---

### Task 6: Add filter bar to companies list

**Files:**
- Modify: `src/routes/_authenticated/companies.tsx`

**Step 1:** Replace the companies page with a version that has a filter bar: search input (filters by name), industry dropdown, and sort selector. All filtering is client-side.

Replace the full contents of `src/routes/_authenticated/companies.tsx`:

```tsx
// src/routes/_authenticated/companies.tsx
import { createFileRoute } from '@tanstack/react-router';
import { useMutation, useQuery } from 'convex/react';
import { useMemo, useState } from 'react';
import { Search, X } from 'lucide-react';
import { api } from '../../../convex/_generated/api';
import type { Id } from '../../../convex/_generated/dataModel';
import type { FormEvent } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { CompanyDetailModal } from '@/components/crm/company-detail-modal';

const INDUSTRIES = ['Technology', 'Healthcare', 'Finance', 'Retail', 'Manufacturing', 'Services', 'Other'];

export const Route = createFileRoute('/_authenticated/companies')({
  component: CompaniesPage,
});

type SortOption = 'name-asc' | 'name-desc' | 'created-desc' | 'created-asc';

function CompaniesPage() {
  const companies = useQuery(api.crm.companies.listCompanies);
  const createCompany = useMutation(api.crm.companies.createCompany);

  // Form state
  const [name, setName] = useState('');
  const [website, setWebsite] = useState('');
  const [selectedCompanyId, setSelectedCompanyId] = useState<Id<'companies'> | null>(null);

  // Filter state
  const [searchQuery, setSearchQuery] = useState('');
  const [industryFilter, setIndustryFilter] = useState<string>('all');
  const [sortBy, setSortBy] = useState<SortOption>('created-desc');

  const onSubmit = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!name.trim()) return;

    await createCompany({
      name: name.trim(),
      website: website.trim() || undefined,
    });

    setName('');
    setWebsite('');
  };

  // Client-side filtering and sorting
  const filteredCompanies = useMemo(() => {
    if (!companies) return [];

    let result = [...companies];

    // Search filter: match name
    if (searchQuery.trim()) {
      const q = searchQuery.trim().toLowerCase();
      result = result.filter((c) => c.name.toLowerCase().includes(q));
    }

    // Industry filter
    if (industryFilter !== 'all') {
      if (industryFilter === 'none') {
        result = result.filter((c) => !c.industry);
      } else {
        result = result.filter((c) => c.industry === industryFilter);
      }
    }

    // Sorting
    result.sort((a, b) => {
      switch (sortBy) {
        case 'name-asc':
          return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
        case 'name-desc':
          return b.name.toLowerCase().localeCompare(a.name.toLowerCase());
        case 'created-desc':
          return b.createdAt - a.createdAt;
        case 'created-asc':
          return a.createdAt - b.createdAt;
        default:
          return 0;
      }
    });

    return result;
  }, [companies, searchQuery, industryFilter, sortBy]);

  const hasActiveFilters = searchQuery.trim().length > 0 || industryFilter !== 'all';

  const clearFilters = () => {
    setSearchQuery('');
    setIndustryFilter('all');
    setSortBy('created-desc');
  };

  return (
    <div className="flex flex-col gap-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Companies</h1>
        <p className="text-muted-foreground">Manage account companies for your CRM workspace.</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>New company</CardTitle>
        </CardHeader>
        <CardContent>
          <form className="grid gap-4 md:grid-cols-3" onSubmit={onSubmit}>
            <div className="space-y-2">
              <Label htmlFor="company-name">Name</Label>
              <Input id="company-name" value={name} onChange={(e) => setName(e.target.value)} />
            </div>
            <div className="space-y-2">
              <Label htmlFor="company-website">Website</Label>
              <Input
                id="company-website"
                value={website}
                onChange={(e) => setWebsite(e.target.value)}
                placeholder="https://example.com"
              />
            </div>
            <div className="md:col-span-3">
              <Button type="submit" disabled={!name.trim()}>
                Create company
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <CardTitle>All companies</CardTitle>
              <CardDescription>
                {filteredCompanies.length}
                {hasActiveFilters ? ` of ${companies?.length ?? 0}` : ''} companies
              </CardDescription>
            </div>
            {hasActiveFilters && (
              <Button variant="ghost" size="sm" onClick={clearFilters} className="gap-1">
                <X className="h-4 w-4" />
                Clear filters
              </Button>
            )}
          </div>
          {/* Filter bar */}
          <div className="flex flex-col gap-3 pt-2 sm:flex-row sm:items-center">
            <div className="relative flex-1 sm:max-w-xs">
              <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search companies..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9"
              />
            </div>
            <Select value={industryFilter} onValueChange={setIndustryFilter}>
              <SelectTrigger className="w-full sm:w-[180px]">
                <SelectValue placeholder="All industries" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All industries</SelectItem>
                <SelectItem value="none">No industry</SelectItem>
                {INDUSTRIES.map((industry) => (
                  <SelectItem key={industry} value={industry}>
                    {industry}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Select value={sortBy} onValueChange={(v) => setSortBy(v as SortOption)}>
              <SelectTrigger className="w-full sm:w-[180px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="created-desc">Newest first</SelectItem>
                <SelectItem value="created-asc">Oldest first</SelectItem>
                <SelectItem value="name-asc">Name A-Z</SelectItem>
                <SelectItem value="name-desc">Name Z-A</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
        <CardContent>
          {!companies || companies.length === 0 ? (
            <p className="text-sm text-muted-foreground">No companies yet.</p>
          ) : filteredCompanies.length === 0 ? (
            <p className="text-sm text-muted-foreground">No companies match your filters.</p>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Name</TableHead>
                  <TableHead>Website</TableHead>
                  <TableHead>Industry</TableHead>
                  <TableHead>Phone</TableHead>
                  <TableHead>Created</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredCompanies.map((company) => (
                  <TableRow
                    key={company._id}
                    className="cursor-pointer"
                    onClick={() => setSelectedCompanyId(company._id)}
                  >
                    <TableCell className="font-medium">{company.name}</TableCell>
                    <TableCell>
                      {company.website ? (
                        <span className="text-muted-foreground">{company.website}</span>
                      ) : '\u2014'}
                    </TableCell>
                    <TableCell>{company.industry ?? '\u2014'}</TableCell>
                    <TableCell>{company.phone ?? '\u2014'}</TableCell>
                    <TableCell className="text-muted-foreground">
                      {new Date(company.createdAt).toLocaleDateString()}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      <CompanyDetailModal
        companyId={selectedCompanyId}
        onClose={() => setSelectedCompanyId(null)}
      />
    </div>
  );
}
```

**Step 2:** Verify it compiles.

```bash
npx tsc --noEmit --pretty
```

Manually test: visit `/companies`, search by name, filter by industry, change sort.

**Step 3:** Commit.

```bash
git add src/routes/_authenticated/companies.tsx
git commit -m "feat: add filter bar to companies list page

Adds search by name, industry dropdown filter, and sort selector.
Client-side filtering via useMemo. Shows filtered count vs total."
```

---

### Task 7: Add filter bar to deals list

**Files:**
- Modify: `src/routes/_authenticated/deals.tsx`

**Step 1:** Replace the deals page with a version that has a filter bar: search input (filters by title), status toggle (All/Open/Won/Lost), stage dropdown, and sort selector. All filtering is client-side.

Replace the full contents of `src/routes/_authenticated/deals.tsx`:

```tsx
// src/routes/_authenticated/deals.tsx
import { createFileRoute } from '@tanstack/react-router';
import { useMutation, useQuery } from 'convex/react';
import { Loader2, Plus, Search, X } from 'lucide-react';
import { useEffect, useMemo, useState } from 'react';
import { api } from '../../../convex/_generated/api';
import type { Id } from '../../../convex/_generated/dataModel';
import type { FormEvent } from 'react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { DealDetailModal } from '@/components/crm/deal-detail-modal';

export const Route = createFileRoute('/_authenticated/deals')({
  component: DealsPage,
});

type StatusFilter = 'all' | 'open' | 'won' | 'lost';
type SortOption = 'created-desc' | 'created-asc' | 'value-desc' | 'value-asc' | 'close-date-asc' | 'close-date-desc';

function DealsPage() {
  const ensureDefaultPipeline = useMutation(api.crm.pipelines.ensureDefaultPipeline);
  const createDeal = useMutation(api.crm.deals.createDeal);

  const defaultPipeline = useQuery(api.crm.pipelines.getDefaultPipeline);
  const stages = useQuery(
    api.crm.pipelines.listStagesByPipeline,
    defaultPipeline ? { pipelineId: defaultPipeline._id } : 'skip',
  );
  const deals = useQuery(api.crm.deals.listDeals);

  // Form state
  const [title, setTitle] = useState('');
  const [value, setValue] = useState('');
  const [stageId, setStageId] = useState('');
  const [selectedDealId, setSelectedDealId] = useState<Id<'deals'> | null>(null);

  // Filter state
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState<StatusFilter>('all');
  const [stageFilter, setStageFilter] = useState<string>('all');
  const [sortBy, setSortBy] = useState<SortOption>('created-desc');

  useEffect(() => {
    if (defaultPipeline === null) {
      ensureDefaultPipeline().catch((error) => {
        console.error('Failed to create default pipeline:', error);
      });
    }
  }, [defaultPipeline, ensureDefaultPipeline]);

  const canSubmit = useMemo(
    () => title.trim().length > 0 && stageId.length > 0 && !!defaultPipeline,
    [title, stageId, defaultPipeline],
  );

  const onSubmit = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!defaultPipeline || !canSubmit) return;

    await createDeal({
      pipelineId: defaultPipeline._id,
      stageId: stageId as Id<'pipelineStages'>,
      title: title.trim(),
      value: value ? Number(value) : undefined,
      currency: 'USD',
    });

    setTitle('');
    setValue('');
  };

  // Client-side filtering and sorting
  const filteredDeals = useMemo(() => {
    if (!deals) return [];

    let result = [...deals];

    // Search filter: match title
    if (searchQuery.trim()) {
      const q = searchQuery.trim().toLowerCase();
      result = result.filter((d) => d.title.toLowerCase().includes(q));
    }

    // Status filter
    if (statusFilter !== 'all') {
      result = result.filter((d) => d.status === statusFilter);
    }

    // Stage filter
    if (stageFilter !== 'all') {
      result = result.filter((d) => d.stageId === stageFilter);
    }

    // Sorting
    result.sort((a, b) => {
      switch (sortBy) {
        case 'created-desc':
          return b.createdAt - a.createdAt;
        case 'created-asc':
          return a.createdAt - b.createdAt;
        case 'value-desc':
          return (b.value ?? 0) - (a.value ?? 0);
        case 'value-asc':
          return (a.value ?? 0) - (b.value ?? 0);
        case 'close-date-asc':
          return (a.expectedCloseDate ?? Number.MAX_SAFE_INTEGER) - (b.expectedCloseDate ?? Number.MAX_SAFE_INTEGER);
        case 'close-date-desc':
          return (b.expectedCloseDate ?? 0) - (a.expectedCloseDate ?? 0);
        default:
          return 0;
      }
    });

    return result;
  }, [deals, searchQuery, statusFilter, stageFilter, sortBy]);

  const hasActiveFilters = searchQuery.trim().length > 0 || statusFilter !== 'all' || stageFilter !== 'all';

  const clearFilters = () => {
    setSearchQuery('');
    setStatusFilter('all');
    setStageFilter('all');
    setSortBy('created-desc');
  };

  if (defaultPipeline === undefined || deals === undefined || stages === undefined) {
    return (
      <div className="flex h-64 items-center justify-center">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Deals</h1>
        <p className="text-muted-foreground">Create and manage opportunities in your CRM.</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>New deal</CardTitle>
          <CardDescription>Add a deal to the current pipeline.</CardDescription>
        </CardHeader>
        <CardContent>
          <form className="grid gap-4 md:grid-cols-3" onSubmit={onSubmit}>
            <div className="space-y-2">
              <Label htmlFor="deal-title">Title</Label>
              <Input
                id="deal-title"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="Website redesign"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="deal-value">Value (USD)</Label>
              <Input
                id="deal-value"
                type="number"
                min="0"
                value={value}
                onChange={(e) => setValue(e.target.value)}
                placeholder="12000"
              />
            </div>
            <div className="space-y-2">
              <Label>Stage</Label>
              <Select value={stageId} onValueChange={setStageId}>
                <SelectTrigger>
                  <SelectValue placeholder="Select stage" />
                </SelectTrigger>
                <SelectContent>
                  {stages.map((stage: { _id: Id<'pipelineStages'>; name: string }) => (
                    <SelectItem key={stage._id} value={stage._id}>
                      {stage.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="md:col-span-3">
              <Button type="submit" disabled={!canSubmit}>
                <Plus className="mr-2 h-4 w-4" />
                Create deal
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <CardTitle>All deals</CardTitle>
              <CardDescription>
                {filteredDeals.length}
                {hasActiveFilters ? ` of ${deals.length}` : ''} deals
              </CardDescription>
            </div>
            {hasActiveFilters && (
              <Button variant="ghost" size="sm" onClick={clearFilters} className="gap-1">
                <X className="h-4 w-4" />
                Clear filters
              </Button>
            )}
          </div>
          {/* Filter bar */}
          <div className="flex flex-col gap-3 pt-2 sm:flex-row sm:flex-wrap sm:items-center">
            <div className="relative flex-1 sm:max-w-xs">
              <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search deals..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-9"
              />
            </div>
            {/* Status toggle */}
            <div className="flex gap-1 rounded-md border p-1">
              {(['all', 'open', 'won', 'lost'] as const).map((status) => (
                <Button
                  key={status}
                  variant={statusFilter === status ? 'default' : 'ghost'}
                  size="sm"
                  className="h-7 px-2.5 text-xs capitalize"
                  onClick={() => setStatusFilter(status)}
                >
                  {status}
                </Button>
              ))}
            </div>
            <Select value={stageFilter} onValueChange={setStageFilter}>
              <SelectTrigger className="w-full sm:w-[180px]">
                <SelectValue placeholder="All stages" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All stages</SelectItem>
                {stages.map((stage: { _id: Id<'pipelineStages'>; name: string }) => (
                  <SelectItem key={stage._id} value={stage._id}>
                    {stage.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Select value={sortBy} onValueChange={(v) => setSortBy(v as SortOption)}>
              <SelectTrigger className="w-full sm:w-[180px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="created-desc">Newest first</SelectItem>
                <SelectItem value="created-asc">Oldest first</SelectItem>
                <SelectItem value="value-desc">Highest value</SelectItem>
                <SelectItem value="value-asc">Lowest value</SelectItem>
                <SelectItem value="close-date-asc">Close date (soonest)</SelectItem>
                <SelectItem value="close-date-desc">Close date (latest)</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
        <CardContent>
          {deals.length === 0 ? (
            <p className="text-sm text-muted-foreground">No deals yet. Create your first one above.</p>
          ) : filteredDeals.length === 0 ? (
            <p className="text-sm text-muted-foreground">No deals match your filters.</p>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Title</TableHead>
                  <TableHead>Value</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead>Stage</TableHead>
                  <TableHead>Close Date</TableHead>
                  <TableHead>Created</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredDeals.map((deal) => {
                  const stage = stages.find(
                    (s: { _id: Id<'pipelineStages'> }) => s._id === deal.stageId,
                  );
                  return (
                    <TableRow
                      key={deal._id}
                      className="cursor-pointer hover:bg-muted/50"
                      onClick={() => setSelectedDealId(deal._id)}
                    >
                      <TableCell className="font-medium">{deal.title}</TableCell>
                      <TableCell>
                        {deal.value != null ? `$${deal.value.toLocaleString()}` : '\u2014'}
                      </TableCell>
                      <TableCell>
                        <Badge
                          variant={
                            deal.status === 'won'
                              ? 'default'
                              : deal.status === 'lost'
                                ? 'destructive'
                                : 'secondary'
                          }
                        >
                          {deal.status}
                        </Badge>
                      </TableCell>
                      <TableCell>{stage?.name ?? '\u2014'}</TableCell>
                      <TableCell className="text-muted-foreground">
                        {deal.expectedCloseDate
                          ? new Date(deal.expectedCloseDate).toLocaleDateString()
                          : '\u2014'}
                      </TableCell>
                      <TableCell className="text-muted-foreground">
                        {new Date(deal.createdAt).toLocaleDateString()}
                      </TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      <DealDetailModal
        dealId={selectedDealId}
        onClose={() => setSelectedDealId(null)}
        stages={stages ?? []}
      />
    </div>
  );
}
```

**Step 2:** Verify it compiles and renders.

```bash
npx tsc --noEmit --pretty
```

Manually test: visit `/deals`, search by title, toggle status buttons, filter by stage, sort by value/close date. Verify the proper table displays with badges.

**Step 3:** Commit.

```bash
git add src/routes/_authenticated/deals.tsx
git commit -m "feat: add filter bar to deals list page

Adds search by title, status toggle buttons (All/Open/Won/Lost), stage
dropdown filter, and sort selector (created, value, close date).
Client-side filtering via useMemo. Shows filtered count vs total."
```

---

## Summary

| Task | File(s) | What | Time Estimate |
|------|---------|------|---------------|
| 1 | `convex/crm/search.ts` (create) | `globalSearch` query: prefix match across deals, contacts, companies | 3 min |
| 2 | `src/components/ui/command.tsx` (create via CLI) | Install shadcn command component + cmdk dependency | 2 min |
| 3 | `src/components/crm/command-palette.tsx` (create) | `CommandPalette` component with live search, grouped results, entity selection | 5 min |
| 4 | `src/components/layout/main-layout.tsx` (modify) | Wire palette + Cmd-K shortcut + search button in header + global detail modals | 5 min |
| 5 | `src/routes/_authenticated/contacts.tsx` (modify) | Filter bar: search input, company dropdown, sort selector | 4 min |
| 6 | `src/routes/_authenticated/companies.tsx` (modify) | Filter bar: search input, industry dropdown, sort selector | 4 min |
| 7 | `src/routes/_authenticated/deals.tsx` (modify) | Filter bar: search input, status toggle, stage dropdown, sort selector | 5 min |

**Total estimated time:** ~28 minutes

**Dependencies:** Tasks 1 and 2 are independent and can be done in parallel. Task 3 depends on Task 2 (needs `command.tsx`). Task 4 depends on Task 3 (needs `CommandPalette`). Tasks 5, 6, 7 are independent of each other and of Tasks 1-4.
