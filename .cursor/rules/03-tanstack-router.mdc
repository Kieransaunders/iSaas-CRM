---
description: TanStack Router patterns - file-based routing, protected routes, layouts
globs: src/routes/**/*.tsx
alwaysApply: true
---

# 3. TanStack Router Patterns

This document covers file-based routing conventions, route protection, and navigation patterns for iSaaSIT.

## File-Based Routing

TanStack Router uses file-based routing. The route tree is auto-generated from files in `src/routes/`.

### Route File Conventions

| File Path | URL Path | Description |
|-----------|----------|-------------|
| `routes/index.tsx` | `/` | Home page |
| `routes/about.tsx` | `/about` | Static page |
| `routes/callback.tsx` | `/callback` | OAuth callback |
| `routes/_authenticated.tsx` | (none) | Layout wrapper (no segment) |
| `routes/_authenticated/dashboard.tsx` | `/dashboard` | Protected route |
| `routes/_authenticated/settings/profile.tsx` | `/settings/profile` | Nested protected route |

### Naming Rules

- Files starting with `_` create layout routes (no URL segment)
- Files with `$` indicate dynamic parameters
- Files with `.` indicate nested routes

## Basic Route Definition

### Public Route

```typescript
// src/routes/index.tsx
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/")({
    component: HomePage,
});

function HomePage() {
    return <div>Welcome to iSaaSIT</div>;
}
```

### Route with Search Params

```typescript
// src/routes/search.tsx
import { createFileRoute } from "@tanstack/react-router";
import { z } from "zod";

const searchSchema = z.object({
    q: z.string().optional(),
    page: z.number().optional().default(1),
});

export const Route = createFileRoute("/search")({
    component: SearchPage,
    validateSearch: searchSchema,
});

function SearchPage() {
    const { q, page } = Route.useSearch();
    return <div>Search: {q}, Page: {page}</div>;
}
```

## Protected Routes

### Layout Pattern

```typescript
// src/routes/_authenticated.tsx
import { createFileRoute, Outlet, redirect } from "@tanstack/react-router";
import { getAuth, getSignInUrl } from "@workos/authkit-tanstack-react-start";

export const Route = createFileRoute("/_authenticated")({
    beforeLoad: async ({ location }) => {
        const { user } = await getAuth();
        if (!user) {
            const href = await getSignInUrl({
                data: { returnPathname: location.pathname },
            });
            throw redirect({ href });
        }
        return { user };
    },
    component: AuthenticatedLayout,
});

function AuthenticatedLayout() {
    const { user } = Route.useRouteContext({ select: (s) => ({ user: s.user }) });
    
    return (
        <div>
            <nav>Welcome, {user.firstName}</nav>
            <Outlet /> {/* Child routes render here */}
        </div>
    );
}
```

### Protected Page

```typescript
// src/routes/_authenticated/dashboard.tsx
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/_authenticated/dashboard")({
    component: DashboardPage,
});

function DashboardPage() {
    // User is guaranteed to be authenticated here
    return <div>Dashboard</div>;
}
```

### Role-Based Protection

```typescript
// src/routes/_authenticated/_admin.tsx
import { createFileRoute, Outlet, redirect } from "@tanstack/react-router";
import { getAuth } from "@workos/authkit-tanstack-react-start";

export const Route = createFileRoute("/_authenticated/_admin")({
    beforeLoad: async () => {
        const { user, orgMembership } = await getAuth();
        
        if (!user) {
            throw redirect({ to: "/" });
        }
        
        // Check if user has Admin role
        const role = orgMembership?.role?.slug;
        if (role !== "admin") {
            throw redirect({ to: "/dashboard" });
        }
        
        return { user, orgMembership };
    },
    component: AdminLayout,
});

function AdminLayout() {
    return (
        <div className="admin-layout">
            <aside>Admin Navigation</aside>
            <main>
                <Outlet />
            </main>
        </div>
    );
}
```

## Data Loading

### Route Loader with Convex

```typescript
// src/routes/_authenticated/customers.tsx
import { createFileRoute } from "@tanstack/react-router";
import { useQuery } from "@tanstack/react-query";
import { convexQuery } from "@convex-dev/react-query";
import { api } from "../../../convex/_generated/api";

export const Route = createFileRoute("/_authenticated/customers")({
    component: CustomersPage,
    loader: async ({ context }) => {
        // Pre-load data or fetch server-side
        const { orgMembership } = await context.queryClient.fetchQuery(
            convexQuery(api.orgs.getCurrentOrg, {})
        );
        return { orgMembership };
    },
});

function CustomersPage() {
    const { orgMembership } = Route.useLoaderData();
    const { data: customers } = useQuery(
        convexQuery(api.customers.list, { orgId: orgMembership.orgId })
    );
    
    return (
        <div>
            <h1>Customers</h1>
            {customers?.map((c) => (
                <div key={c._id}>{c.name}</div>
            ))}
        </div>
    );
}
```

### Pending Component

```typescript
export const Route = createFileRoute("/_authenticated/customers")({
    component: CustomersPage,
    pendingComponent: () => <div>Loading customers...</div>,
});
```

### Error Handling

```typescript
export const Route = createFileRoute("/_authenticated/customers")({
    component: CustomersPage,
    errorComponent: ({ error }) => (
        <div className="error">Failed to load: {error.message}</div>
    ),
});
```

## Navigation

### Type-Safe Links

```typescript
import { Link } from "@tanstack/react-router";

// ✅ Type-safe - will error if route doesn't exist
<Link to="/dashboard">Dashboard</Link>

// ✅ With params
<Link to="/customers/$customerId" params={{ customerId: "123" }}>
    View Customer
</Link>

// ✅ With search params
<Link to="/search" search={{ q: "test", page: 1 }}>
    Search
</Link>
```

### Programmatic Navigation

```typescript
import { useNavigate } from "@tanstack/react-router";

function MyComponent() {
    const navigate = useNavigate();
    
    const handleClick = () => {
        navigate({ to: "/dashboard" });
    };
    
    const handleRedirect = () => {
        navigate({ to: "/login", search: { redirect: "/dashboard" } });
    };
    
    return <button onClick={handleClick}>Go to Dashboard</button>;
}
```

## Nested Layouts

### Multiple Layout Levels

```
src/routes/
├── __root.tsx              # Root layout (all pages)
├── _authenticated.tsx      # Auth wrapper
├── _authenticated/
│   ├── _admin.tsx          # Admin layout
│   ├── _admin/
│   │   └── billing.tsx     # /billing (admin only)
│   ├── dashboard.tsx       # /dashboard (any auth user)
│   └── settings.tsx        # /settings (any auth user)
└── index.tsx               # / (public)
```

### Root Layout

```typescript
// src/routes/__root.tsx
import { createRootRoute, Outlet } from "@tanstack/react-router";
import { ConvexProviderWithAuth } from "@convex-dev/react-query";
import { AuthKitProvider } from "@workos/authkit-tanstack-react-start";

export const Route = createRootRoute({
    component: RootComponent,
});

function RootComponent() {
    return (
        <AuthKitProvider>
            <ConvexProviderWithAuth client={convex}>
                <Outlet />
            </ConvexProviderWithAuth>
        </AuthKitProvider>
    );
}
```

## URL Parameters

### Dynamic Segments

```typescript
// src/routes/_authenticated/customers/$customerId.tsx
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/_authenticated/customers/$customerId")({
    component: CustomerDetailPage,
});

function CustomerDetailPage() {
    const { customerId } = Route.useParams();
    
    const { data: customer } = useQuery(
        convexQuery(api.customers.get, { customerId })
    );
    
    return <div>{customer?.name}</div>;
}
```

### Catch-All Routes

```typescript
// src/routes/docs.$.tsx
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/docs/$")({
    component: DocsPage,
});

function DocsPage() {
    const { _splat } = Route.useParams();
    // _splat contains everything after /docs/
    return <div>Doc path: {_splat}</div>;
}
```

## Common Patterns for iSaaSIT

### Org Context in Routes

```typescript
// src/routes/_authenticated.tsx (enhanced)
export const Route = createFileRoute("/_authenticated")({
    beforeLoad: async ({ context, location }) => {
        const { user, orgMembership } = await getAuth();
        
        if (!user) {
            const href = await getSignInUrl({
                data: { returnPathname: location.pathname },
            });
            throw redirect({ href });
        }
        
        // Fetch org from Convex
        const org = await context.queryClient.fetchQuery(
            convexQuery(api.orgs.getByWorkOsId, { 
                workOsOrgId: orgMembership.orgId 
            })
        );
        
        return { user, orgMembership, org };
    },
    component: AuthenticatedLayout,
});
```

### Customer-Scoped Routes

```typescript
// src/routes/_authenticated/customers/$customerId/_layout.tsx
import { createFileRoute, Outlet } from "@tanstack/react-router";

export const Route = createFileRoute(
    "/_authenticated/customers/$customerId/_layout"
)({
    component: CustomerLayout,
});

function CustomerLayout() {
    const { customerId } = Route.useParams();
    const { data: customer } = useQuery(
        convexQuery(api.customers.get, { customerId })
    );
    
    return (
        <div>
            <header>{customer?.name}</header>
            <Outlet />
        </div>
    );
}
```

### Active Route Styling

```typescript
import { Link, useMatches } from "@tanstack/react-router";

function Navigation() {
    const matches = useMatches();
    
    return (
        <nav>
            <Link
                to="/dashboard"
                className={matches.some(m => m.routeId === "/_authenticated/dashboard") 
                    ? "active" 
                    : ""
                }
            >
                Dashboard
            </Link>
        </nav>
    );
}
```

## Route Generation

After adding/modifying route files, the route tree is auto-generated. If needed, regenerate:

```bash
# Stop dev server and restart, or:
npx tanstack-router generate
```

The generated file is at `src/routeTree.gen.ts` - **do not edit manually**.
