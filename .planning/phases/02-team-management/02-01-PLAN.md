---
phase: 02-team-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/invitations/send.ts
  - convex/invitations/manage.ts
  - convex/invitations/queries.ts
autonomous: true
user_setup:
  - service: workos
    why: "Webhook endpoint must be configured in WorkOS dashboard for invitation.accepted events"
    dashboard_config:
      - task: "Add webhook endpoint URL for invitation.accepted events"
        location: "WorkOS Dashboard -> Webhooks -> Create Webhook"

must_haves:
  truths:
    - "pendingInvitations table exists in Convex schema with correct fields"
    - "users table has deletedAt optional field for soft delete"
    - "Admin can send invitation via WorkOS API through Convex action"
    - "Pending invitation is stored in Convex with role and optional customerId"
    - "Admin can revoke a pending invitation"
    - "Admin can resend an expired or pending invitation"
  artifacts:
    - path: "convex/schema.ts"
      provides: "pendingInvitations table definition, deletedAt field on users"
      contains: "pendingInvitations"
    - path: "convex/invitations/send.ts"
      provides: "sendInvitation action calling WorkOS API"
      exports: ["sendInvitation"]
    - path: "convex/invitations/manage.ts"
      provides: "revokeInvitation and resendInvitation actions"
      exports: ["revokeInvitation", "resendInvitation"]
    - path: "convex/invitations/queries.ts"
      provides: "listPendingInvitations query"
      exports: ["listPendingInvitations"]
  key_links:
    - from: "convex/invitations/send.ts"
      to: "WorkOS userManagement.sendInvitation API"
      via: "WorkOS Node SDK in Convex action"
      pattern: "workos\\.userManagement\\.sendInvitation"
    - from: "convex/invitations/send.ts"
      to: "convex/schema.ts pendingInvitations table"
      via: "ctx.runMutation to store pending invitation"
      pattern: "pendingInvitations"
    - from: "convex/invitations/manage.ts"
      to: "WorkOS userManagement.revokeInvitation API"
      via: "WorkOS Node SDK in Convex action"
      pattern: "workos\\.userManagement\\.revokeInvitation"
---

<objective>
Add the pendingInvitations table to the Convex schema, add soft-delete support to users, and create the invitation backend (send, revoke, resend) that calls WorkOS User Management API.

Purpose: This is the data foundation for team management. Without the schema and invitation actions, no team member can be invited or tracked.
Output: Updated schema.ts with pendingInvitations table and deletedAt on users, plus three Convex files for invitation actions and queries.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-management/02-RESEARCH.md

# Existing files to understand patterns
@convex/schema.ts
@convex/workos/createOrg.ts
@convex/orgs/get.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update schema with pendingInvitations table and soft-delete field</name>
  <files>convex/schema.ts</files>
  <action>
Add a `pendingInvitations` table to the Convex schema with these fields:
- `workosInvitationId: v.string()` — the ID returned by WorkOS sendInvitation
- `email: v.string()` — invited user's email
- `orgId: v.id("orgs")` — which org this invitation belongs to
- `role: v.union(v.literal("staff"), v.literal("client"))` — the role being invited
- `customerId: v.optional(v.id("customers"))` — only set when role is "client"
- `inviterUserId: v.id("users")` — who sent the invite
- `createdAt: v.number()`
- `expiresAt: v.number()`

Add these indexes:
- `by_org: ["orgId"]`
- `by_workos_id: ["workosInvitationId"]`
- `by_email_org: ["email", "orgId"]` (to prevent duplicate invites to same email in same org)

Also add `deletedAt: v.optional(v.number())` field to the existing `users` table. This enables soft delete for user removal. Place it after the existing fields, before the timestamps comment.

Do NOT remove or modify any existing tables or fields. Only ADD.
  </action>
  <verify>Run `npx convex dev --once` from the project root to verify schema compiles. Grep schema.ts for "pendingInvitations" and "deletedAt" to confirm both additions.</verify>
  <done>pendingInvitations table defined with all fields and indexes. users table has deletedAt optional field. Schema compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create invitation actions (send, revoke, resend) and query</name>
  <files>convex/invitations/send.ts, convex/invitations/manage.ts, convex/invitations/queries.ts</files>
  <action>
Create the `convex/invitations/` directory with three files:

**convex/invitations/send.ts** — Convex action (needs `"use node"` directive):
- Export `sendInvitation` action with args: `{ email: v.string(), role: v.union(v.literal("staff"), v.literal("client")), customerId: v.optional(v.id("customers")) }`
- Auth check: get user identity, look up user record, verify role is "admin" (only admins can invite)
- Look up user's org via internal query (reuse pattern from `convex/workos/updateOrg.ts` using `internal.orgs.get.getMyOrgInternal`)
- Validate: if role is "client", customerId MUST be provided (throw ConvexError if missing)
- Validate: check org's maxStaff/maxClients caps before sending (count existing users + pending invitations of that role). Throw ConvexError with descriptive limit message if at cap.
- Call `workos.userManagement.sendInvitation({ organizationId: org.workosOrgId, email: args.email, expiresInDays: 7, inviterUserId: identity.subject })`
- After WorkOS returns, store pending invitation in Convex via an internal mutation: insert into pendingInvitations with workosInvitationId, email, orgId, role, customerId, inviterUserId, createdAt: Date.now(), expiresAt: Date.now() + 7*24*60*60*1000
- Return `{ invitationId: workosInvitation.id }`
- Wrap WorkOS call in try/catch, rethrow as ConvexError with user-friendly message

Create a corresponding internal mutation `storePendingInvitation` in the same file (or a separate internal file) for the action to call.

**convex/invitations/manage.ts** — Convex actions (needs `"use node"` directive):
- Export `revokeInvitation` action with args: `{ invitationId: v.id("pendingInvitations") }`
  - Auth check (admin only)
  - Look up the pending invitation in Convex by _id
  - Verify invitation belongs to user's org
  - Call `workos.userManagement.revokeInvitation(invitation.workosInvitationId)`
  - Delete the pending invitation record from Convex via internal mutation
  - Return `{ success: true }`

- Export `resendInvitation` action with args: `{ invitationId: v.id("pendingInvitations") }`
  - Auth check (admin only)
  - Look up the pending invitation in Convex
  - Verify invitation belongs to user's org
  - Revoke the old WorkOS invitation, then send a new one with same parameters
  - Update the Convex record with new workosInvitationId and new expiresAt
  - Return `{ success: true }`

**convex/invitations/queries.ts** — Convex query (no "use node" needed):
- Export `listPendingInvitations` query (no args needed — uses auth context)
  - Auth check, get user record, verify admin role
  - Query pendingInvitations table by orgId index
  - Return array of pending invitations
  - Include customer name by looking up customerId if present

Follow existing patterns:
- Use `ConvexError` for all user-facing errors
- Use `"use node"` directive only in files with WorkOS SDK calls
- Use `internal.*` for mutations called from actions
- Initialize WorkOS with `new WorkOS(process.env.WORKOS_API_KEY)`
  </action>
  <verify>Run `npx convex dev --once` to verify all functions compile. Grep for exports: `sendInvitation`, `revokeInvitation`, `resendInvitation`, `listPendingInvitations`. Verify `npx tsc --noEmit` passes.</verify>
  <done>Three invitation files exist with all exports. Actions call WorkOS API and store/manage pending invitations in Convex. Query returns pending invitations for the org. All compile without errors.</done>
</task>

</tasks>

<verification>
- `npx convex dev --once` passes (schema + functions compile)
- `npx tsc --noEmit` passes (no TypeScript errors)
- `pendingInvitations` table in schema.ts has all required fields and indexes
- `deletedAt` field exists on users table
- `sendInvitation` action validates role, enforces caps, calls WorkOS, stores in Convex
- `revokeInvitation` and `resendInvitation` actions handle WorkOS API calls
- `listPendingInvitations` query returns org's pending invitations
</verification>

<success_criteria>
- Schema updated with pendingInvitations table (7 fields, 3 indexes) and deletedAt on users
- sendInvitation action enforces admin-only, validates client requires customerId, enforces usage caps, calls WorkOS, stores record
- revokeInvitation deletes from both WorkOS and Convex
- resendInvitation revokes old + sends new in WorkOS, updates Convex record
- listPendingInvitations returns all pending invitations for current user's org
- All files compile and pass TypeScript checks
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-01-SUMMARY.md`
</output>
