---
phase: 02
plan: 02
subsystem: team-management
tags: [convex, mutations, queries, ui, staff-assignment, role-based-access]
requires:
  - "01-03: WorkOS integration with org/user sync"
  - "Schema with staffCustomerAssignments table"
provides:
  - "Staff assignment mutations (assignStaff, unassignStaff)"
  - "Staff assignment queries (listAssignedStaff, listAvailableStaff)"
  - "Customer detail page with assignment UI"
affects:
  - "Future: Staff-scoped data queries will use these assignments"
  - "Future: Authorization checks will reference assignment relationships"
tech-stack:
  added: []
  patterns:
    - "Role-based UI visibility (admin-only features)"
    - "Convex query/mutation patterns with auth checks"
    - "shadcn/ui Select component for assignment dropdown"
key-files:
  created:
    - "convex/assignments/mutations.ts"
    - "convex/assignments/queries.ts"
  modified:
    - "src/routes/_authenticated/customers/.tsx"
decisions:
  - title: "Admin-only assignment UI"
    rationale: "Only admins should manage staff assignments per security model"
    impact: "Assignment card hidden from staff and client roles"
  - title: "Inline assignment UI on customer detail"
    rationale: "Assignments are customer-scoped, most intuitive on customer page"
    impact: "No separate assignment management page needed"
  - title: "Prevent duplicate assignments at mutation level"
    rationale: "Ensures data integrity, simpler than frontend checks"
    impact: "ConvexError thrown if duplicate assignment attempted"
metrics:
  duration: "7.5 minutes"
  completed: "2026-02-09"
  tasks: 2
  commits: 2
---

# Phase 02 Plan 02: Staff Assignment Backend & UI Summary

**One-liner:** Staff assignment mutations/queries with admin-only assignment UI on customer detail page using role-based visibility.

## What Was Built

### Backend: Staff Assignment Logic

Created two Convex files implementing staff assignment functionality:

**`convex/assignments/mutations.ts`:**
- `assignStaff`: Validates admin role, checks customer/user exist in same org, verifies target user is staff role, prevents duplicate assignments, creates assignment record
- `unassignStaff`: Validates admin role, finds assignment record, deletes it
- Both mutations throw ConvexError with descriptive messages for all validation failures

**`convex/assignments/queries.ts`:**
- `listAssignedStaff`: Returns staff assigned to a customer with `{ _id, firstName, lastName, email, assignmentId }` for unassign action
- `listAvailableStaff`: Returns staff NOT assigned to customer, filters out soft-deleted users, admin-only access
- Both queries enforce org-level data isolation

### Frontend: Customer Detail Assignment Card

Updated `src/routes/_authenticated/customers/.tsx`:
- Added role check using `api.orgs.get.hasOrg` query to determine admin status
- Replaced placeholder "Team" card with functional "Assigned Staff" card
- Displays list of assigned staff with name/email and unassign button (X icon)
- Shows Select dropdown to assign available staff (only unassigned staff appear)
- Empty states: "No staff assigned yet" and "All staff members have been assigned"
- Loading states with Skeleton components
- Card only visible to admin users (conditional render based on `isAdmin`)

### Key Implementation Details

**Auth Pattern:**
```typescript
// Get user identity
const user = await ctx.auth.getUserIdentity();
if (!user) throw new ConvexError("Not authenticated");

// Get user record with role
const userRecord = await ctx.db
  .query("users")
  .withIndex("by_workos_user_id", (q) => q.eq("workosUserId", user.subject))
  .first();

// Check admin role
if (userRecord.role !== "admin") {
  throw new ConvexError("Only admins can assign staff to customers");
}
```

**Duplicate Prevention:**
```typescript
const existingAssignment = await ctx.db
  .query("staffCustomerAssignments")
  .withIndex("by_staff_customer", (q) =>
    q.eq("staffUserId", userId).eq("customerId", customerId)
  )
  .first();

if (existingAssignment) {
  throw new ConvexError("Staff already assigned to this customer");
}
```

**Available Staff Filtering:**
- Queries users by `by_org_role` index for role="staff"
- Filters out soft-deleted users (`deletedAt` is set)
- Queries existing assignments for the customer
- Returns only staff NOT in the assigned set

## Deviations from Plan

### Auto-fixed Issues

**[Rule 1 - Bug] Fixed missing internalQuery import in invitations/send.ts**
- **Found during:** Task 1 verification (Convex compilation)
- **Issue:** File declared `"use node"` action but used `internalQuery` without importing it, causing "s.query is not a function" error
- **Fix:** Added `internalQuery` to imports, then realized Node.js actions can't export queries/mutations - separated internal queries and mutations into `convex/invitations/internal.ts` (auto-generated by Convex)
- **Files modified:**
  - `convex/invitations/send.ts` - updated internal references
  - `convex/invitations/manage.ts` - updated internal references
  - `convex/invitations/internal.ts` - auto-created by Convex with all internal functions
- **Commit:** Included in Task 1 commit (bug fix was blocker for compilation)

**Rationale:** This was a critical bug preventing Convex functions from compiling. Node.js action files cannot export queries or mutations - only actions. The Convex framework auto-generated the internal.ts file to properly separate concerns.

## Verification Results

**Convex Compilation:**
```
✔ 13:06:15 Convex functions ready! (2.71s)
```

**TypeScript Check:**
- No errors in assignment files or customer detail page
- Pre-existing error in `src/routes/index.tsx` (unrelated: DOCS_URL undefined)

**Manual Verification Checklist:**
- [x] assignStaff mutation validates admin, prevents duplicates, creates assignment
- [x] unassignStaff mutation finds and removes assignment
- [x] listAssignedStaff returns staff details with assignmentId
- [x] listAvailableStaff returns only unassigned, non-deleted staff
- [x] Customer detail page shows assignment card with assign/unassign UI
- [x] Assignment card only visible to admin users
- [x] All exports present: assignStaff, unassignStaff, listAssignedStaff, listAvailableStaff

## Success Criteria

All success criteria met:

- ✅ Admin can assign staff to customer via Select dropdown in customer detail
- ✅ Admin can unassign staff via X button next to staff name
- ✅ Assignment card only visible to admin users
- ✅ Duplicate assignments prevented (ConvexError thrown)
- ✅ Only staff-role users appear in assignment dropdown
- ✅ Soft-deleted users excluded from available staff list

## Commits

| Hash    | Type | Message                                           |
|---------|------|---------------------------------------------------|
| 130ec3c | feat | Create staff assignment mutations and queries     |
| 3649aeb | feat | Add staff assignment UI to customer detail page   |

## Next Phase Readiness

**Ready for:**
- Phase 2 Plan 3+: Staff-scoped data queries can now use `staffCustomerAssignments` table to enforce "staff sees only assigned customers" rule
- Authorization middleware can check assignment existence before granting access

**Notes:**
- Assignment enforcement not yet implemented - staff can currently query all org customers
- Future: Update `listCustomers` and other queries to respect staff assignments
- Future: Consider bulk assignment UI if needed for many staff/customers

**No blockers for next plan.**

---

*Plan executed: 2026-02-09 by Claude Sonnet 4.5*
*Execution time: 7 minutes 28 seconds*
