---
phase: 02-team-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/assignments/mutations.ts
  - convex/assignments/queries.ts
  - src/routes/_authenticated/customers/.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can assign a staff user to a customer from customer detail page"
    - "Admin can unassign a staff user from a customer"
    - "Customer detail page shows list of currently assigned staff"
    - "Customer detail page shows dropdown to assign available (unassigned) staff"
    - "Only staff users appear in the assignment dropdown"
  artifacts:
    - path: "convex/assignments/mutations.ts"
      provides: "assignStaff and unassignStaff mutations"
      exports: ["assignStaff", "unassignStaff"]
    - path: "convex/assignments/queries.ts"
      provides: "listAssignedStaff and listAvailableStaff queries"
      exports: ["listAssignedStaff", "listAvailableStaff"]
    - path: "src/routes/_authenticated/customers/.tsx"
      provides: "Staff assignment UI card in customer detail"
      contains: "Assigned Staff"
  key_links:
    - from: "src/routes/_authenticated/customers/.tsx"
      to: "convex/assignments/queries.ts"
      via: "useQuery for listAssignedStaff and listAvailableStaff"
      pattern: "api\\.assignments\\.queries\\.(listAssignedStaff|listAvailableStaff)"
    - from: "src/routes/_authenticated/customers/.tsx"
      to: "convex/assignments/mutations.ts"
      via: "useMutation for assignStaff and unassignStaff"
      pattern: "api\\.assignments\\.mutations\\.(assignStaff|unassignStaff)"
---

<objective>
Create staff assignment backend (mutations + queries) and add the assignment UI card to the customer detail page. Admin can assign/unassign staff to customers.

Purpose: Fulfills ASSIGN-02, ASSIGN-03, ASSIGN-04 requirements. Staff assignment is how data scoping works -- staff only see customers they're assigned to.
Output: Two Convex files for assignment logic, updated customer detail page with assignment card.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing files to understand patterns
@convex/schema.ts
@convex/customers/crud.ts
@src/routes/_authenticated/customers/.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create staff assignment mutations and queries</name>
  <files>convex/assignments/mutations.ts, convex/assignments/queries.ts</files>
  <action>
Create the `convex/assignments/` directory with two files:

**convex/assignments/mutations.ts** — Convex mutations:

Export `assignStaff` mutation:
- Args: `{ customerId: v.id("customers"), userId: v.id("users") }`
- Auth check: get user identity, look up user record, verify role is "admin"
- Verify the customer belongs to the admin's org
- Verify the target user exists, belongs to same org, and has role "staff" (throw ConvexError "Only staff users can be assigned to customers" if not)
- Check for existing assignment using `by_staff_customer` index to prevent duplicates (throw ConvexError "Staff already assigned to this customer" if exists)
- Insert into `staffCustomerAssignments` with staffUserId, customerId, orgId, createdAt: Date.now()
- Return the assignment ID

Export `unassignStaff` mutation:
- Args: `{ customerId: v.id("customers"), userId: v.id("users") }`
- Auth check: admin only
- Find the assignment record using `by_staff_customer` index
- Throw ConvexError "Assignment not found" if no record exists
- Delete the assignment record
- Return `{ success: true }`

**convex/assignments/queries.ts** — Convex queries:

Export `listAssignedStaff` query:
- Args: `{ customerId: v.id("customers") }`
- Auth check: get user record, verify user has access to this customer (admin of same org)
- Query `staffCustomerAssignments` by `by_customer` index for the given customerId
- For each assignment, look up the staff user record (ctx.db.get)
- Return array of `{ _id, firstName, lastName, email, assignmentId }` — include assignmentId for unassign action
- Filter out any null results (deleted staff)

Export `listAvailableStaff` query:
- Args: `{ customerId: v.id("customers") }`
- Auth check: admin of same org
- Get all staff users in the org: query users table by `by_org_role` index where orgId = user's org and role = "staff"
- Filter out users where `deletedAt` is set (soft-deleted users)
- Get already-assigned staff IDs for this customer
- Return only staff NOT already assigned
- Return array of `{ _id, firstName, lastName, email }`

Follow existing patterns from `convex/customers/crud.ts`:
- Use `ConvexError` for all errors
- Auth check first, then permission check, then business logic
- Use typed imports: `import type { Id } from "../_generated/dataModel"`
  </action>
  <verify>Run `npx convex dev --once` to verify functions compile. Grep for exports: `assignStaff`, `unassignStaff`, `listAssignedStaff`, `listAvailableStaff`.</verify>
  <done>Four functions exported across two files. assignStaff validates admin role, prevents duplicates, inserts assignment. unassignStaff finds and deletes assignment. Queries return assigned and available staff lists. All compile.</done>
</task>

<task type="auto">
  <name>Task 2: Add staff assignment UI card to customer detail page</name>
  <files>src/routes/_authenticated/customers/.tsx</files>
  <action>
Add a "Staff Assignment" card to the customer detail page (`src/routes/_authenticated/customers/.tsx`).

Read the existing file first to understand its layout, then add:

1. Import the new assignment queries and mutations:
   - `api.assignments.queries.listAssignedStaff`
   - `api.assignments.queries.listAvailableStaff`
   - `api.assignments.mutations.assignStaff`
   - `api.assignments.mutations.unassignStaff`

2. Import additional UI components: `Select`, `SelectContent`, `SelectItem`, `SelectTrigger`, `SelectValue` from `@/components/ui/select`

3. Import icon: `X` from `lucide-react` (for unassign button)

4. In the component, add queries and mutations:
   ```tsx
   const assignedStaff = useQuery(api.assignments.queries.listAssignedStaff, { customerId: customerId as any });
   const availableStaff = useQuery(api.assignments.queries.listAvailableStaff, { customerId: customerId as any });
   const assignStaffMutation = useMutation(api.assignments.mutations.assignStaff);
   const unassignStaffMutation = useMutation(api.assignments.mutations.unassignStaff);
   ```

5. Create handler functions:
   - `handleAssignStaff(staffUserId: string)` — calls assignStaffMutation with customerId and userId
   - `handleUnassignStaff(staffUserId: string)` — calls unassignStaffMutation with customerId and userId

6. Add the assignment Card BELOW the existing customer detail card(s). The card should contain:
   - CardHeader with CardTitle "Assigned Staff" and CardDescription "Staff members with access to this customer"
   - CardContent with:
     a. List of assigned staff: each row shows staff name (firstName + lastName) and email, with an X button on the right to unassign. Use `Button variant="ghost" size="sm"` for the unassign button.
     b. Empty state if no staff assigned: "No staff assigned yet"
     c. Below the list, a Select dropdown labeled "Assign staff..." that shows available (unassigned) staff. When a staff member is selected, immediately call handleAssignStaff. Reset select after assignment.

7. Only show the assignment card to admin users. Check the user's role from the user profile query (if available) or add a simple role check. If the current user is not admin, hide the card entirely.

Use existing component patterns from the file. Follow shadcn/ui Select component patterns.
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Grep the customer detail file for "Assigned Staff", "assignStaff", "unassignStaff", "listAvailableStaff" to confirm all wiring.</verify>
  <done>Customer detail page has a "Staff Assignment" card visible to admins. Shows assigned staff with unassign buttons. Shows dropdown to assign available staff. All wired to Convex mutations and queries. No TypeScript errors.</done>
</task>

</tasks>

<verification>
- `npx convex dev --once` passes
- `npx tsc --noEmit` passes
- assignStaff mutation validates admin, prevents duplicates, creates assignment
- unassignStaff mutation finds and removes assignment
- listAssignedStaff returns staff details for a customer
- listAvailableStaff returns only unassigned, non-deleted staff
- Customer detail page shows assignment card with working assign/unassign UI
</verification>

<success_criteria>
- Admin can assign staff to customer via Select dropdown in customer detail
- Admin can unassign staff via X button next to staff name
- Assignment card only visible to admin users
- Duplicate assignments prevented
- Only staff-role users appear in assignment dropdown
- Soft-deleted users excluded from available staff list
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-02-SUMMARY.md`
</output>
