---
phase: 02-team-management
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - src/routes/_authenticated/team.tsx
  - src/components/team/invite-dialog.tsx
  - src/components/team/team-table.tsx
autonomous: true

must_haves:
  truths:
    - "Team page shows tabbed table with All / Staff / Clients / Pending tabs"
    - "Each tab shows correct filtered subset of members or invitations"
    - "Tab counts reflect actual data (staff count, client count, pending count)"
    - "Invite dialog opens from top-right button"
    - "Invite form has email, role picker, and conditional customer dropdown for client role"
    - "Admin can resend or revoke pending invitations from the Pending tab"
    - "Admin can remove an active user with confirmation dialog"
    - "Admin can restore a removed user"
  artifacts:
    - path: "src/routes/_authenticated/team.tsx"
      provides: "Team page with tabs, invite button, table rendering"
      contains: "TeamPage"
    - path: "src/components/team/invite-dialog.tsx"
      provides: "Invite dialog with email, role picker, conditional customer dropdown"
      contains: "InviteDialog"
    - path: "src/components/team/team-table.tsx"
      provides: "Reusable team table component with action buttons"
      contains: "TeamTable"
  key_links:
    - from: "src/routes/_authenticated/team.tsx"
      to: "convex/users/queries.ts"
      via: "useQuery for listOrgMembers and getOrgMemberCounts"
      pattern: "api\\.users\\.queries\\.(listOrgMembers|getOrgMemberCounts)"
    - from: "src/routes/_authenticated/team.tsx"
      to: "convex/invitations/queries.ts"
      via: "useQuery for listPendingInvitations"
      pattern: "api\\.invitations\\.queries\\.listPendingInvitations"
    - from: "src/components/team/invite-dialog.tsx"
      to: "convex/invitations/send.ts"
      via: "useAction for sendInvitation"
      pattern: "api\\.invitations\\.send\\.sendInvitation"
    - from: "src/routes/_authenticated/team.tsx"
      to: "convex/users/manage.ts"
      via: "useMutation for removeUser and restoreUser"
      pattern: "api\\.users\\.manage\\.(removeUser|restoreUser)"
---

<objective>
Build the full Team page UI: tabbed member table (All/Staff/Clients/Pending), invite dialog with role picker and conditional customer dropdown, and member management actions (remove, restore, resend, revoke).

Purpose: This is the primary admin interface for team management. It brings together all the backend work from Plans 01 and 03 into a usable UI.
Output: Rewritten team.tsx page, InviteDialog component, TeamTable component.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-management/02-CONTEXT.md
@.planning/phases/02-team-management/02-RESEARCH.md

# Prior plan outputs for API knowledge
@.planning/phases/02-team-management/02-01-SUMMARY.md
@.planning/phases/02-team-management/02-03-SUMMARY.md

# Existing patterns
@src/routes/_authenticated/team.tsx
@src/routes/_authenticated/customers.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InviteDialog and TeamTable components</name>
  <files>src/components/team/invite-dialog.tsx, src/components/team/team-table.tsx</files>
  <action>
Create the `src/components/team/` directory with two component files.

**src/components/team/invite-dialog.tsx:**

Props interface `InviteDialogProps`:
- `open: boolean`
- `onOpenChange: (open: boolean) => void`

Component `InviteDialog`:
- Uses Dialog from `@/components/ui/dialog` (DialogContent, DialogHeader, DialogTitle, DialogDescription)
- Form state: `email` (string), `role` ("staff" | "client"), `customerId` (string | undefined), `isSubmitting` (boolean), `error` (string | null)
- Uses `useAction` for `api.invitations.send.sendInvitation`
- Uses `useQuery` for `api.customers.crud.listCustomers` (to populate customer dropdown — only needed when role is "client")
- Form fields:
  1. Email Input with type="email", required
  2. Role Select with two options: "Staff" and "Client" — use `@/components/ui/select`
  3. Conditional Customer Select: only visible when role === "client". Shows list of customers from the org. Use `@/components/ui/select`. Required when visible.
- Submit handler:
  - Validate email is non-empty and contains @
  - If role is "client", validate customerId is selected
  - Call sendInvitation action with { email, role, customerId }
  - On success: close dialog, reset form state
  - On error: display error message in the dialog (use Alert component or inline text)
  - Set isSubmitting during the async call
- Cancel/close resets form state
- Submit button text: "Send Invite" (disabled while isSubmitting)

**src/components/team/team-table.tsx:**

Props interface `TeamTableProps`:
- `members: Array<{ _id: string, firstName?: string, lastName?: string, email: string, role?: string, status: string, createdAt: number, deletedAt?: number }>`
- `onRemove?: (userId: string) => void`
- `onRestore?: (userId: string) => void`

For pending invitations, create a separate component or accept a different prop shape:

Props interface `PendingTableProps`:
- `invitations: Array<{ _id: string, email: string, role: string, customerName?: string, createdAt: number, expiresAt: number }>`
- `onResend?: (invitationId: string) => void`
- `onRevoke?: (invitationId: string) => void`

Export `TeamTable` component:
- Uses Table, TableHeader, TableBody, TableRow, TableCell, TableHead from `@/components/ui/table`
- Columns: Name (firstName + lastName or email), Email, Role, Status (Badge), Joined (formatted date), Actions
- Status badges: "Active" (default/green), "Removed" (destructive/red) — use Badge component with appropriate variant
- Role display: capitalize first letter
- Actions column:
  - For active users: "Remove" button (destructive ghost variant). onClick opens confirmation AlertDialog: "Are you sure you want to remove [name]? They will lose access to the organization."
  - For removed users: "Restore" button (outline variant)
- Empty state: "No team members" with icon
- Import AlertDialog from `@/components/ui/alert-dialog` for confirmation

Export `PendingTable` component:
- Columns: Email, Role, Customer (if client), Sent (formatted date), Expires, Actions
- Actions: "Resend" button (outline), "Revoke" button (destructive ghost)
- Empty state: "No pending invitations" with "Invite your first team member" text

Use `date-fns` format function for date formatting (already in project dependencies — check). If not available, use `new Date(timestamp).toLocaleDateString()`.

Follow existing component patterns: PascalCase filenames, named exports, TypeScript interfaces for props.
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Grep for "InviteDialog" and "TeamTable" and "PendingTable" exports in the component files.</verify>
  <done>InviteDialog component renders form with email, role picker, conditional customer dropdown, and sends invitation via Convex action. TeamTable renders members with remove/restore actions and confirmation dialog. PendingTable renders invitations with resend/revoke actions. All compile.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite team page with tabs and wire to backend</name>
  <files>src/routes/_authenticated/team.tsx</files>
  <action>
Completely rewrite `src/routes/_authenticated/team.tsx` (the existing file is a placeholder with static content).

Read the existing file first, then replace with:

**Imports:**
- TanStack Router: `createFileRoute`
- Convex React: `useQuery`, `useMutation`, `useAction`
- API imports: `api` from convex/_generated
- UI components: Tabs, TabsList, TabsTrigger, TabsContent from `@/components/ui/tabs`
- UI components: Button from `@/components/ui/button`
- Icons: Plus from `lucide-react`
- Custom components: InviteDialog from `@/components/team/invite-dialog`
- Custom components: TeamTable, PendingTable from `@/components/team/team-table`
- React: useState

**Route definition:**
```tsx
export const Route = createFileRoute('/_authenticated/team')({
  component: TeamPage,
});
```

**TeamPage component:**

State:
- `isInviteOpen` (boolean, default false)

Queries:
- `const members = useQuery(api.users.queries.listOrgMembers)`
- `const counts = useQuery(api.users.queries.getOrgMemberCounts)`
- `const pendingInvitations = useQuery(api.invitations.queries.listPendingInvitations)`

Mutations:
- `const removeUser = useMutation(api.users.manage.removeUser)`
- `const restoreUser = useMutation(api.users.manage.restoreUser)`

Actions:
- `const revokeInvitation = useAction(api.invitations.manage.revokeInvitation)`
- `const resendInvitation = useAction(api.invitations.manage.resendInvitation)`

Derived data:
- `staffMembers` = members filtered to role === "staff" and status === "active"
- `clientMembers` = members filtered to role === "client" and status === "active"
- `allActiveMembers` = members filtered to status === "active" (includes admin)
- Use counts query for tab badges: `All (${counts?.totalActive ?? 0})`, `Staff (${counts?.staffCount ?? 0})`, etc.

Layout:
```
<div className="flex flex-col gap-6">
  <!-- Header -->
  <div className="flex items-center justify-between">
    <div>
      <h1 className="text-3xl font-bold tracking-tight">Team</h1>
      <p className="text-muted-foreground">Manage your team members and invitations</p>
    </div>
    <Button onClick={() => setIsInviteOpen(true)}>
      <Plus className="mr-2 h-4 w-4" />
      Invite Member
    </Button>
  </div>

  <!-- Tabs -->
  <Tabs defaultValue="all">
    <TabsList>
      <TabsTrigger value="all">All ({counts?.totalActive ?? 0})</TabsTrigger>
      <TabsTrigger value="staff">Staff ({counts?.staffCount ?? 0})</TabsTrigger>
      <TabsTrigger value="clients">Clients ({counts?.clientCount ?? 0})</TabsTrigger>
      <TabsTrigger value="pending">Pending ({counts?.pendingCount ?? 0})</TabsTrigger>
    </TabsList>

    <TabsContent value="all">
      <TeamTable members={allActiveMembers} onRemove={...} />
    </TabsContent>
    <TabsContent value="staff">
      <TeamTable members={staffMembers} onRemove={...} />
    </TabsContent>
    <TabsContent value="clients">
      <TeamTable members={clientMembers} onRemove={...} />
    </TabsContent>
    <TabsContent value="pending">
      <PendingTable invitations={pendingInvitations} onResend={...} onRevoke={...} />
    </TabsContent>
  </Tabs>

  <!-- Invite Dialog -->
  <InviteDialog open={isInviteOpen} onOpenChange={setIsInviteOpen} />
</div>
```

Handler functions:
- `handleRemove(userId)`: call removeUser({ userId }), show toast or handle error
- `handleRestore(userId)`: call restoreUser({ userId })
- `handleRevoke(invitationId)`: call revokeInvitation({ invitationId })
- `handleResend(invitationId)`: call resendInvitation({ invitationId })

Loading states:
- If members or counts are undefined (loading), show Skeleton components for the table
- If members is empty array, show the empty state from TeamTable component

Handle the case where the Convex ID types need casting (the team-table component receives string IDs, but Convex mutations need typed IDs — use `as any` or type the props with Id<"users">).
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors. Grep team.tsx for: "TabsTrigger", "InviteDialog", "TeamTable", "PendingTable", "listOrgMembers", "removeUser", "restoreUser". Start dev server and verify the page renders without console errors (if dev environment is available).</verify>
  <done>Team page has working tabs (All/Staff/Clients/Pending) with correct filtering and counts. Invite button opens InviteDialog. Member table shows remove/restore actions. Pending tab shows resend/revoke actions. All wired to Convex backend. No TypeScript errors.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Team page renders with 4 tabs
- Tab counts reflect backend data
- Invite dialog opens, shows email + role picker, conditionally shows customer dropdown
- Invite form calls sendInvitation action
- Member table shows name, email, role, status, actions
- Remove button shows confirmation dialog then calls removeUser
- Restore button calls restoreUser
- Pending tab shows invitations with resend/revoke buttons
</verification>

<success_criteria>
- Team page fully replaced from placeholder to functional admin interface
- InviteDialog collects email, role, optional customer, submits to backend
- TeamTable displays org members with role badges and status
- PendingTable displays pending invitations with management actions
- Confirmation dialog before removal
- Loading states handled with skeletons
- Empty states for each tab
- All TypeScript types correct
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-04-SUMMARY.md`
</output>
