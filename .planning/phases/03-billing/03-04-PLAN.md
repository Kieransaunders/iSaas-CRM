---
phase: 03-billing
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - convex/invitations/send.ts
  - convex/customers/crud.ts
  - src/routes/_authenticated/customers.tsx
  - src/components/billing/CapReachedBanner.tsx
  - src/routes/_authenticated.tsx
autonomous: true

must_haves:
  truths:
    - "Creating a customer when at maxCustomers limit shows upgrade prompt (not just error)"
    - "Inviting staff when at maxStaff limit shows upgrade prompt"
    - "Inviting client when at maxClients limit shows upgrade prompt"
    - "Warning banner appears at 80%+ usage of any limit"
    - "Upgrade prompts link to billing page or open checkout overlay"
  artifacts:
    - path: "src/components/billing/CapReachedBanner.tsx"
      provides: "Reusable warning banner and inline upgrade prompt"
      exports: ["CapReachedBanner", "UsageWarningBanner"]
    - path: "src/routes/_authenticated/customers.tsx"
      provides: "Customer creation with inline upgrade prompt on limit"
      contains: "limit reached|CapReached|upgrade"
  key_links:
    - from: "src/routes/_authenticated/customers.tsx"
      to: "convex/customers/crud.ts"
      via: "mutation error handling"
      pattern: "catch.*limit reached"
    - from: "src/routes/_authenticated.tsx"
      to: "convex/billing/queries.ts"
      via: "useQuery for usage stats"
      pattern: "useQuery.*getUsageStats"
    - from: "src/components/billing/CapReachedBanner.tsx"
      to: "src/routes/_authenticated/billing.tsx"
      via: "Link to billing page"
      pattern: "href.*billing|navigate.*billing"
---

<objective>
Add cap enforcement UX: inline upgrade prompts when limits are hit, and a warning banner when approaching limits.

Purpose: Users need clear feedback when they hit plan limits (hard block with upgrade path) and proactive warning when approaching limits (80%+ usage banner). This is the user-facing side of cap enforcement (backend caps already exist).

Output: Warning banner component, inline upgrade prompts in create dialogs, and improved error handling for limit-reached scenarios.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-billing/03-RESEARCH.md
@.planning/phases/03-billing/03-01-SUMMARY.md

Key existing code to reference:
@convex/customers/crud.ts (existing cap enforcement pattern: throws ConvexError with "limit reached" message)
@convex/invitations/send.ts (existing cap enforcement for staff/client invitations)
@src/routes/_authenticated/customers.tsx (customer creation dialog - add inline upgrade prompt)
@src/routes/_authenticated.tsx (authenticated layout wrapper - add warning banner)
@convex/billing/queries.ts (getUsageStats -- from plan 03-02, may or may not be available yet)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CapReachedBanner and UsageWarningBanner components</name>
  <files>
    src/components/billing/CapReachedBanner.tsx
  </files>
  <action>
Create `src/components/billing/CapReachedBanner.tsx` with two exported components:

**`CapReachedBanner` component (inline upgrade prompt for dialogs/forms):**
- Props: `resourceType: "customers" | "staff" | "clients"`, `currentCount: number`, `maxCount: number`
- Render when `currentCount >= maxCount`:
  - Yellow/amber alert-style box with border (use existing Card or a styled div)
  - Icon: AlertTriangle from lucide-react
  - Message: "{Resource} limit reached ({currentCount}/{maxCount}). Upgrade your plan to add more."
  - "Upgrade Plan" button (links to /billing page using TanStack Router Link)
- Compact design that fits inside dialogs/forms without overwhelming the UI
- If `currentCount < maxCount`, render null (invisible)

**`UsageWarningBanner` component (app-wide 80%+ warning):**
- Props: `usage: { customers: { count: number, max: number }, staff: { count: number, max: number }, clients: { count: number, max: number } }`
- Calculate which resources are at 80%+ usage
- If ANY resource is at 80%+, render a dismissible banner:
  - Amber background, horizontal layout
  - "You're approaching your plan limits" with specifics (e.g., "Customers: 8/10, Staff: 2/2")
  - Only list resources at 80%+
  - "Upgrade" button linking to /billing
  - Dismiss "X" button (stores dismissal in component state -- reappears on page refresh, which is fine)
- If NO resource is at 80%+, render null

Both components use existing shadcn components (Button, Card/Alert) and lucide-react icons.
Use TanStack Router's Link component for navigation to /billing (not href).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Check that CapReachedBanner renders conditionally based on count >= max. Check UsageWarningBanner calculates 80% threshold correctly.
  </verify>
  <done>
CapReachedBanner shows inline upgrade prompt in forms when at limit. UsageWarningBanner shows dismissible app-wide banner when any resource at 80%+ usage. Both link to /billing for upgrade.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire upgrade prompts into customer creation and authenticated layout</name>
  <files>
    src/routes/_authenticated/customers.tsx
    src/routes/_authenticated.tsx
  </files>
  <action>
**Update `src/routes/_authenticated/customers.tsx`:**
- Read the existing file first to understand current structure
- Add `useQuery(api.customers.crud.getCustomerUsage)` to get current count/max (this query already exists)
- In the customer creation dialog/form:
  1. Import CapReachedBanner from `@/components/billing/CapReachedBanner`
  2. Add CapReachedBanner inside the dialog, below the form fields but above the submit button
  3. Pass `resourceType="customers"`, `currentCount={usage.count}`, `maxCount={usage.max}`
  4. When at limit: the banner shows and the submit button should be disabled
- In the mutation error handler (where createCustomer is called):
  1. Check if error message includes "limit reached" or "Customer limit"
  2. If so, show the CapReachedBanner inline (set a state flag)
  3. For other errors, show generic error toast/message

**Update `src/routes/_authenticated.tsx`:**
- Import `useQuery` from `convex/react` and `api`
- Import UsageWarningBanner from `@/components/billing/CapReachedBanner`
- Inside AuthenticatedLayout component, add usage query:
  - `const usageStats = useQuery(api.billing.queries.getUsageStats)`
  - NOTE: If plan 03-02 hasn't run yet and `convex/billing/queries.ts` doesn't exist, use `api.customers.crud.getCustomerUsage` as a simpler fallback and wire in the full usage query later
- Place UsageWarningBanner above the Outlet (so it appears at top of every authenticated page):
  ```jsx
  <MainLayout breadcrumbs={[{ label: "Dashboard" }]}>
    {usageStats && <UsageWarningBanner usage={usageStats.usage} />}
    <Outlet />
  </MainLayout>
  ```
- The banner only renders when a resource is at 80%+, so it's invisible most of the time

**IMPORTANT considerations:**
- The `useQuery` call in _authenticated.tsx is a real-time subscription. When usage changes (customer created, invitation sent), the banner updates automatically.
- Don't break existing functionality -- the layout must still work for users without orgs (onboarding redirect).
- Only show the banner if usageStats is defined (not during loading).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Check that:
1. Customer creation dialog has CapReachedBanner
2. Authenticated layout has UsageWarningBanner
3. Banner only renders when usage >= 80%
4. Submit button disabled when at customer limit
  </verify>
  <done>
Customer creation dialog shows inline upgrade prompt when at limit with disabled submit. Authenticated layout shows dismissible warning banner when any resource at 80%+ usage. All existing functionality preserved.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Customer creation: at limit -> shows CapReachedBanner + disabled submit button
3. Customer creation: below limit -> no banner, submit enabled
4. Authenticated layout: 80%+ usage on any resource -> warning banner visible
5. Authenticated layout: below 80% -> no banner
6. Warning banner links to /billing page
7. CapReachedBanner links to /billing page
</verification>

<success_criteria>
- Hard block on customer creation at limit with inline upgrade prompt
- Warning banner appears at 80%+ usage across all authenticated pages
- Both prompts direct users to billing page for upgrade
- Existing functionality (customer CRUD, layout) not broken
- Real-time usage updates via Convex subscription
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing/03-04-SUMMARY.md`
</output>
