---
phase: 03-billing
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/routes/_authenticated/billing.tsx
  - src/components/billing/UpgradeButton.tsx
  - src/components/billing/UsageProgress.tsx
autonomous: false

must_haves:
  truths:
    - "Billing page shows current plan name from database (not hardcoded)"
    - "Usage progress bars show real counts from Convex with color coding"
    - "Upgrade button opens Lemon Squeezy checkout overlay in-app"
    - "Cancel button opens confirmation dialog and calls cancel action"
    - "Plan cards show Free/Pro/Business with correct limits"
    - "Manage Subscription button links to Lemon Squeezy customer portal"
    - "Trial banner shows days remaining when org is on a trial subscription"
    - "View Invoices button opens Lemon Squeezy customer portal for invoice history"
  artifacts:
    - path: "src/routes/_authenticated/billing.tsx"
      provides: "Full billing dashboard with real data"
      contains: "useQuery.*getUsageStats"
    - path: "src/components/billing/UpgradeButton.tsx"
      provides: "Button that loads Lemon.js and triggers checkout overlay"
      contains: "LemonSqueezy.Url.Open"
    - path: "src/components/billing/UsageProgress.tsx"
      provides: "Color-coded progress bars for usage display"
      contains: "bg-red|bg-yellow|bg-green"
  key_links:
    - from: "src/routes/_authenticated/billing.tsx"
      to: "convex/billing/queries.ts"
      via: "useQuery hooks"
      pattern: "useQuery.*api.billing.queries"
    - from: "src/components/billing/UpgradeButton.tsx"
      to: "convex/billing/actions.ts"
      via: "useAction for checkout URL"
      pattern: "useAction.*createCheckoutUrl"
    - from: "src/routes/_authenticated/billing.tsx"
      to: "src/components/billing/UpgradeButton.tsx"
      via: "component import"
      pattern: "import.*UpgradeButton"
    - from: "src/routes/_authenticated/billing.tsx"
      to: "convex/billing/actions.ts"
      via: "useAction for customer portal URL"
      pattern: "useAction.*getCustomerPortalUrl"
---

<objective>
Rebuild the billing page with live data, checkout overlay, and subscription management UI.

Purpose: Users need to see their real usage, upgrade their plan via Lemon Squeezy overlay, and manage/cancel subscriptions. This replaces the hardcoded placeholder billing page with a fully functional billing dashboard.

Output: Working billing page showing real plan/usage data, Lemon Squeezy checkout overlay for upgrades, and cancel subscription flow.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-billing/03-RESEARCH.md
@.planning/phases/03-billing/03-01-SUMMARY.md
@.planning/phases/03-billing/03-02-SUMMARY.md

Key existing code to reference:
@src/routes/_authenticated/billing.tsx (current placeholder billing page to replace)
@src/routes/_authenticated/dashboard.tsx (UsageBar pattern, Card layout pattern)
@convex/billing/queries.ts (getUsageStats, getBillingInfo -- from plan 03-02)
@convex/billing/actions.ts (createCheckoutUrl, cancelSubscription -- from plan 03-02)
@convex/lemonsqueezy/plans.ts (PLAN_TIERS, getPlanName -- from plan 03-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UpgradeButton and UsageProgress components</name>
  <files>
    src/components/billing/UpgradeButton.tsx
    src/components/billing/UsageProgress.tsx
  </files>
  <action>
Create `src/components/billing/UpgradeButton.tsx`:
- Component that loads Lemon.js dynamically and triggers checkout overlay
- Props: `variantId: string`, `email: string`, `orgName: string`, `orgConvexId: string`, `disabled?: boolean`, `children?: ReactNode`
- Use `useEffect` to load Lemon.js script from `https://app.lemonsqueezy.com/js/lemon.js`:
  1. Create script element, set src, defer = true
  2. On load: call `window.createLemonSqueezy()` to initialize for React, set loaded state
  3. Append to document.body
  4. Cleanup: remove script on unmount
- Add TypeScript declarations for `window.createLemonSqueezy` and `window.LemonSqueezy` (add `declare global` block or a separate `.d.ts`)
- `handleUpgrade` function:
  1. Build checkout URL: `https://${STORE_SLUG}.lemonsqueezy.com/checkout/buy/${variantId}`
  2. Append query params: `checkout[email]`, `checkout[name]`, `checkout[custom][org_convex_id]`
  3. STORE_SLUG comes from env var exposed to client -- use `import.meta.env.VITE_LEMONSQUEEZY_STORE_SLUG` (Vite exposes VITE_ prefixed vars to client)
  4. Call `window.LemonSqueezy.Url.Open(checkoutUrl)`
- Render a shadcn Button with onClick={handleUpgrade}, disabled if not loaded or disabled prop
- Default children: "Upgrade Plan"

Create `src/components/billing/UsageProgress.tsx`:
- Props: `label: string`, `used: number`, `max: number`, `icon?: LucideIcon`
- Calculate percentage: `Math.min((used / max) * 100, 100)`
- Color thresholds (user decision: green/yellow/red):
  - >= 90%: red (`bg-red-500`)
  - >= 80%: yellow/amber (`bg-amber-500`)
  - < 80%: green (`bg-green-500`)
- Render:
  - Icon + label row
  - Count display: `{used}/{max}` with large bold number
  - Progress bar: shadcn-style `h-2 rounded-full bg-muted` container with colored fill div
  - Transition animation on width change: `transition-all duration-300`
  </action>
  <verify>
Verify files compile with `npx tsc --noEmit`. Check UpgradeButton has Lemon.js script loading in useEffect. Check UsageProgress has 3 color thresholds.
  </verify>
  <done>
UpgradeButton loads Lemon.js CDN script, initializes for React, and opens checkout overlay with pre-filled data. UsageProgress shows color-coded progress bars (green < 80%, amber 80-89%, red 90%+).
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite billing page with real data and subscription management</name>
  <files>src/routes/_authenticated/billing.tsx</files>
  <action>
Rewrite `src/routes/_authenticated/billing.tsx` completely (replace all existing content):

**Data fetching:**
- `const usageStats = useQuery(api.billing.queries.getUsageStats)`
- `const billingInfo = useQuery(api.billing.queries.getBillingInfo)`
- `const org = useQuery(api.orgs.get.getMyOrg)` (for org name, email)
- `const getPortalUrl = useAction(api.billing.actions.getCustomerPortalUrl)` (for invoice portal)
- Show Skeleton/Loader2 while data is loading

**Page structure (user decisions from CONTEXT.md):**

1. **Header section:**
   - "Billing" title with "Manage your subscription and usage" subtitle

2. **Trial banner (conditional, above Current Plan card):**
   - Only show when `billingInfo.isTrialing === true`
   - Amber/blue info banner: "You're on a 14-day free trial of Pro. {X} days remaining."
   - Calculate days remaining from `billingInfo.trialDaysRemaining`
   - Include "Upgrade Now" button (UpgradeButton for Pro variant) to convert trial to paid
   - If trial is expiring soon (3 days or less): use amber/warning style
   - If trial has more time: use blue/info style

3. **Current Plan card:**
   - Plan name badge (Free/Pro/Business) from usageStats.plan.name
   - Subscription status badge (active/cancelled/past_due/inactive)
   - If trialing: show "Trial" badge alongside plan name (e.g., "Pro (Trial)")
   - For active subscriptions: show "Manage Subscription" button (links to Lemon Squeezy customer portal -- construct URL or use a placeholder, since portal URLs are pre-signed and come from API)
   - For inactive/free: show UpgradeButton component
   - For cancelled: show "Cancelled - active until [date]" message + UpgradeButton to re-subscribe

4. **Usage section (3-column grid):**
   - Import and use UsageProgress component for each:
     - Customers: usageStats.usage.customers.count / .max, icon Building2
     - Team Members: usageStats.usage.staff.count / .max, icon Users
     - External Users: usageStats.usage.clients.count / .max, icon UserCircle

5. **Available Plans section (3-column grid):**
   - Update plan cards to match user's 3 tiers: Free ($0/mo), Pro ($29/mo), Business ($99/mo)
   - Rename "Enterprise" to "Business" (user decision: 3 tiers are Free/Pro/Business)
   - Each card: name, price, feature list, CTA button
   - Current plan card has border highlight and "Current Plan" badge
   - Non-current plans show UpgradeButton with appropriate variantId
   - Use `PLAN_TIERS` from `convex/lemonsqueezy/plans` to get feature limits (or inline them if import from convex/ to src/ is awkward -- define plan display info in a client-side constant)

6. **Invoice section (only if org has an active or cancelled subscription):**
   - Section title: "Invoices"
   - "View Invoices & Receipts" button that opens Lemon Squeezy customer portal in new tab
   - On click: call `useAction(api.billing.actions.getCustomerPortalUrl)` to get the pre-signed portal URL, then `window.open(portalUrl, '_blank')`
   - Show loading spinner on button while fetching portal URL
   - If no subscription (free tier, never subscribed): show "No invoices yet" message
   - NOTE: Per research, invoices are NOT stored in Convex. The Lemon Squeezy customer portal handles invoice display, receipts, and tax compliance. This is the simplest approach that satisfies Decision #13 (invoice list with date, amount, status, receipt link) -- the LS portal provides all of this.

7. **Cancel subscription section (at bottom, only if subscriptionStatus is "active"):**
   - "Cancel Subscription" button (destructive variant)
   - Opens AlertDialog (shadcn) with confirmation:
     - Title: "Cancel Subscription"
     - Description: "Your subscription will remain active until the end of your current billing period. After that, your workspace will be downgraded to the Free plan with reduced limits. Your data will be preserved but you won't be able to create new resources beyond Free tier limits."
     - Cancel button + Confirm button
   - On confirm: call `useAction(api.billing.actions.cancelSubscription)`
   - Show loading state during cancellation
   - On success: show toast or update UI with "Cancelled, active until [date]"

**State management:**
- `const [isCancelling, setIsCancelling] = useState(false)`
- `const [showCancelDialog, setShowCancelDialog] = useState(false)`
- `const [isLoadingPortal, setIsLoadingPortal] = useState(false)`

**Import shadcn components that may not exist yet:**
- If AlertDialog is not installed, run `npx shadcn@latest add alert-dialog` first
- Use existing Card, Button, Badge components
  </action>
  <verify>
Run `npx tsc --noEmit` to check for type errors. Verify billing page imports useQuery for billing queries. Verify UpgradeButton component is used with variant IDs. Verify cancel flow uses AlertDialog with confirmation. Verify invoice section uses getCustomerPortalUrl action. Verify trial banner renders conditionally based on billingInfo.isTrialing.
  </verify>
  <done>
Billing page shows real plan name and status, trial banner with days remaining (when trialing), live usage progress bars with colors, upgrade buttons that open Lemon Squeezy overlay, plan comparison cards, invoice section with "View Invoices" button opening LS customer portal, and cancel subscription flow with confirmation dialog.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification checkpoint for billing dashboard UX</name>
  <files>
    src/routes/_authenticated/billing.tsx
    src/components/billing/UpgradeButton.tsx
    src/components/billing/UsageProgress.tsx
  </files>
  <action>
Run the manual verification checklist below in a browser and block plan completion until a human reviewer confirms the observed behavior matches expected billing UX and flows.
  </action>
  <what-built>Complete billing dashboard with real usage data, checkout overlay, and subscription management</what-built>
  <how-to-verify>
1. Navigate to /billing in your browser
2. Verify current plan shows "Free" (or your actual plan if subscribed)
3. Verify usage bars show real counts (customers, staff, clients) with color coding
4. Click "Upgrade" on a plan card â€” verify Lemon Squeezy checkout overlay appears in-app
5. Close the overlay (don't complete payment unless in test mode)
6. If you have an active subscription: verify "Cancel Subscription" button shows, click it, verify confirmation dialog appears, dismiss it
7. Check that plan feature limits match: Free (3/2/10), Pro (25/10/100), Business (100/50/500)
8. If on a trial: verify trial banner appears at top with days remaining and "Upgrade Now" button
9. If on free (no subscription): verify "No invoices yet" message in invoice section
10. If subscribed: verify "View Invoices & Receipts" button exists in invoice section (clicking opens LS portal in new tab)
  </how-to-verify>
  <verify>Reviewer completes the checklist and confirms pass/fail results for each step.</verify>
  <done>Human reviewer provides "approved" or a concrete issue list for follow-up.</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Billing page loads without errors and shows real data from Convex
2. Usage progress bars are color-coded (green < 80%, amber 80-89%, red 90%+)
3. Upgrade button triggers Lemon Squeezy checkout overlay (not redirect)
4. Cancel subscription shows confirmation dialog
5. Plan cards show correct tier information (Free/Pro/Business)
6. Page handles loading states gracefully (skeletons/spinners)
7. Trial banner shows when billingInfo.isTrialing is true, hidden otherwise
8. Invoice section shows "View Invoices" button that calls getCustomerPortalUrl action
9. Invoice section shows "No invoices yet" when on free tier with no subscription history
</verification>

<success_criteria>
- Billing page displays live usage data from Convex queries
- UpgradeButton loads Lemon.js and opens checkout overlay with pre-filled email/name
- UsageProgress shows color-coded bars at 80% and 90% thresholds
- Cancel flow has confirmation dialog and calls Lemon Squeezy API
- All 3 plan tiers displayed with correct limits and pricing
- Trial banner displays days remaining and upgrade CTA when on trial
- Invoice section opens Lemon Squeezy customer portal for invoice viewing
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing/03-03-SUMMARY.md`
</output>
