---
phase: 03-billing
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Admin clicks Upgrade -> Lemon Squeezy checkout overlay opens with pre-filled email"
    - "After payment -> org subscription status is active (via webhook)"
    - "Plan caps updated from subscription (maxCustomers, maxStaff, maxClients)"
    - "Billing page shows real counts vs limits with colored progress bars"
    - "Creating customer blocked at limit with upgrade prompt"
    - "Warning banner appears when at 80%+ of any limit"
    - "Cancel subscription shows confirmation and processes via API"
    - "Trial banner shows days remaining when org is on 14-day Pro trial"
    - "View Invoices button opens Lemon Squeezy customer portal"
  artifacts:
    - path: "src/routes/_authenticated/billing.tsx"
      provides: "Billing dashboard with upgrade, cancellation, trial, and invoice access flows"
      contains: "useQuery.*getUsageStats|UpgradeButton|AlertDialog|getCustomerPortalUrl"
    - path: "convex/lemonsqueezy/webhook.ts"
      provides: "Webhook intake and signature verification for subscription lifecycle sync"
      contains: "verifySignature|ctx.runMutation"
    - path: "src/routes/_authenticated/customers.tsx"
      provides: "Customer cap enforcement UX with inline upgrade prompt"
      contains: "CapReachedBanner|disabled"
    - path: "src/components/team/invite-dialog.tsx"
      provides: "Invite cap enforcement UX for staff/client limits"
      contains: "CapReachedBanner|limit reached"
  key_links:
    - from: "src/components/billing/UpgradeButton.tsx"
      to: "Lemon Squeezy checkout overlay"
      via: "window.LemonSqueezy.Url.Open with pre-filled checkout params"
      pattern: "LemonSqueezy\\.Url\\.Open"
    - from: "convex/lemonsqueezy/webhook.ts"
      to: "convex/lemonsqueezy/sync.ts"
      via: "internal mutation dispatch for subscription events"
      pattern: "ctx\\.runMutation.*processSubscriptionEvent"
    - from: "src/routes/_authenticated/customers.tsx"
      to: "src/components/billing/CapReachedBanner.tsx"
      via: "inline upgrade prompt when maxCustomers is reached"
      pattern: "CapReachedBanner"
    - from: "src/components/team/invite-dialog.tsx"
      to: "src/components/billing/CapReachedBanner.tsx"
      via: "inline upgrade prompt for staff/client invite limit errors"
      pattern: "CapReachedBanner"
---

<objective>
End-to-end verification of the complete billing system.

Purpose: Confirm all billing components work together: checkout overlay, webhook processing, plan cap enforcement, billing dashboard, and subscription management. This is the user acceptance checkpoint for the entire phase.

Output: Verified billing flow from checkout through cap enforcement.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing/03-01-SUMMARY.md
@.planning/phases/03-billing/03-02-SUMMARY.md
@.planning/phases/03-billing/03-03-SUMMARY.md
@.planning/phases/03-billing/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compile and deploy verification</name>
  <files></files>
  <action>
Run full build verification:
1. `npx convex dev --once` -- verify all Convex functions compile and deploy
2. `npx tsc --noEmit` -- verify all TypeScript compiles without errors
3. `npm run build` -- verify frontend builds successfully
4. Check that convex/http.ts is deployed with webhook route
5. Verify all new files exist:
   - convex/http.ts
   - convex/lemonsqueezy/webhook.ts
   - convex/lemonsqueezy/signature.ts
   - convex/lemonsqueezy/sync.ts
   - convex/lemonsqueezy/plans.ts
   - convex/billing/queries.ts
   - convex/billing/actions.ts
   - src/components/billing/UpgradeButton.tsx
   - src/components/billing/UsageProgress.tsx
   - src/components/billing/CapReachedBanner.tsx
6. Verify no lint errors: `npm run lint` (fix any issues found)
  </action>
  <verify>All build commands exit with 0. All files exist. No lint errors.</verify>
  <done>Full codebase compiles, builds, and passes linting.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human end-to-end acceptance checkpoint for billing phase</name>
  <files>
    src/routes/_authenticated/billing.tsx
    src/routes/_authenticated/customers.tsx
    src/components/team/invite-dialog.tsx
    convex/lemonsqueezy/webhook.ts
  </files>
  <action>
Execute the acceptance checklist below and pause completion until a human reviewer confirms the full billing flow works end-to-end (or records specific gaps for follow-up).
  </action>
  <what-built>Complete billing system: Lemon Squeezy checkout overlay, webhook processing, plan cap enforcement, billing dashboard, usage warnings</what-built>
  <how-to-verify>
**Billing Dashboard (navigate to /billing):**
1. Page loads with real usage data (not hardcoded zeros)
2. Current plan shows "Free" with correct limits
3. Usage bars are color-coded (green if under 80%)
4. Three plan cards displayed: Free ($0), Pro ($29), Business ($99)

**Trial Display:**
5. If org is on a trial: verify trial banner appears with days remaining
6. Trial banner has "Upgrade Now" button
7. Current plan card shows "Pro (Trial)" badge when trialing

**Checkout Flow:**
8. Click "Upgrade" on Pro or Business card
9. Lemon Squeezy checkout overlay appears in-app (not a redirect)
10. Email and org name are pre-filled in checkout
11. Close overlay without completing payment

**Cap Enforcement:**
12. If at customer limit: go to /customers, try to create a customer
13. Inline upgrade prompt should appear with disabled submit button
14. If NOT at limit: create customers until at limit, then verify prompt appears

**Warning Banner:**
15. If at 80%+ of any limit: verify amber warning banner appears at top of page
16. Banner should link to /billing page

**Invoice Section:**
17. If on free tier (never subscribed): verify "No invoices yet" message
18. If subscribed: verify "View Invoices & Receipts" button exists
19. Click button â€” verify it opens Lemon Squeezy customer portal in new tab (requires LS config)

**Webhook Setup (if Lemon Squeezy test mode configured):**
20. Complete a test payment through the overlay
21. Verify org subscription status updates to "active" in billing page
22. Verify plan caps increase (e.g., from 3 to 25 customers for Pro)

**Cancel Flow (if subscription active):**
23. Click "Cancel Subscription" button on billing page
24. Confirmation dialog appears with explanation text
25. Dismiss dialog (don't actually cancel unless testing)

NOTE: If Lemon Squeezy is not configured yet (no API keys/webhook secret), steps 8-11, 19, and 20-25 can be deferred. The page structure, data queries, trial display, cap enforcement, invoice section layout, and warning banners should all work without Lemon Squeezy configuration.
  </how-to-verify>
  <verify>Reviewer executes checklist items and records pass/fail outcomes for each applicable step.</verify>
  <done>Reviewer responds "approved" for closure or provides concrete issues for a gap-closure plan.</done>
  <resume-signal>Type "approved" to complete Phase 3, or describe issues for gap closure</resume-signal>
</task>

</tasks>

<verification>
Phase 3 requirements checklist:
- BILL-01: Org has subscription status synced from Lemon Squeezy -> webhook handler processes events and updates org fields (including trial_ends_at)
- BILL-02: Admin can upgrade via Lemon Squeezy checkout -> UpgradeButton opens overlay
- BILL-03: Webhook handler processes subscription events -> convex/lemonsqueezy/webhook.ts with signature verification
- BILL-04: Plan caps update on subscription change -> sync.ts maps variant ID to limits
- BILL-05: Usage cap enforced on staff/client creation -> existing enforcement + inline upgrade prompts
- BILL-06: Billing page shows real usage from Convex -> getUsageStats query wired to billing page
- BILL-07: 14-day Pro trial tracked and displayed -> trial banner with days remaining on billing page
- BILL-08: Invoice access via customer portal -> "View Invoices" button opens LS portal
</verification>

<success_criteria>
All 8 BILL requirements verified:
1. Webhook infrastructure deployed and processing events (including trial state)
2. Checkout overlay opens with pre-filled data
3. Subscription events update org status and caps
4. Billing page shows live usage data with colored progress bars
5. Cap enforcement blocks creation with inline upgrade prompt
6. Warning banner shows at 80%+ usage
7. Trial banner shows days remaining when org is on 14-day Pro trial
8. Invoice section provides access to Lemon Squeezy customer portal
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing/03-05-SUMMARY.md`
</output>
