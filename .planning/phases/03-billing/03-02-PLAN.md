---
phase: 03-billing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/billing/queries.ts
  - convex/billing/actions.ts
autonomous: true
user_setup:
  - service: lemonsqueezy
    why: "Server-side API calls for checkout and cancellation"
    env_vars:
      - name: LEMONSQUEEZY_API_KEY
        source: "Lemon Squeezy Dashboard -> Settings -> API -> API keys"
      - name: LEMONSQUEEZY_STORE_ID
        source: "Lemon Squeezy Dashboard -> Settings -> Stores -> Store ID"
      - name: LEMONSQUEEZY_STORE_SLUG
        source: "Lemon Squeezy Dashboard -> Settings -> Stores -> Store slug (subdomain, e.g. 'mystore' from mystore.lemonsqueezy.com)"

must_haves:
  truths:
    - "Admin can request a checkout URL for a specific plan variant"
    - "Admin can cancel an existing subscription"
    - "Admin can get a customer portal URL for invoice viewing"
    - "Billing query returns real customer/staff/client counts from database"
    - "Billing query returns org subscription status, plan name, and trial info"
    - "Non-admin users cannot create checkouts or cancel subscriptions"
  artifacts:
    - path: "convex/billing/queries.ts"
      provides: "Usage stats and billing info queries"
      exports: ["getUsageStats", "getBillingInfo"]
    - path: "convex/billing/actions.ts"
      provides: "Checkout URL creation, subscription cancellation, and customer portal URL"
      exports: ["createCheckoutUrl", "cancelSubscription", "getCustomerPortalUrl"]
  key_links:
    - from: "convex/billing/queries.ts"
      to: "convex schema orgs table"
      via: "reads subscription fields and counts entities"
      pattern: "ctx.db.query.*orgs|customers|users"
    - from: "convex/billing/actions.ts"
      to: "@lemonsqueezy/lemonsqueezy.js"
      via: "SDK calls for checkout, cancellation, and customer portal"
      pattern: "lemonSqueezySetup|cancelSubscription|getCustomer"
---

<objective>
Create billing backend operations: usage statistics queries and Lemon Squeezy API actions for checkout and cancellation.

Purpose: The billing page and upgrade prompts need data (usage counts, plan info) and the ability to trigger checkout and cancel subscriptions. This plan provides the server-side API surface for all billing UI interactions.

Output: Convex queries for billing data and actions for Lemon Squeezy API operations (create checkout URL, cancel subscription).
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing/03-RESEARCH.md

Key existing code to reference:
@convex/schema.ts (org table fields, users table with role/orgId, customers table)
@convex/orgs/get.ts (pattern for authenticated queries, getMyOrg pattern)
@convex/invitations/internal.ts (getOrgUserCounts pattern for counting users by role)
@convex/invitations/send.ts (pattern for "use node" actions with WorkOS SDK)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing usage and info queries</name>
  <files>convex/billing/queries.ts</files>
  <action>
Create `convex/billing/queries.ts`:

Install the Lemon Squeezy SDK first: `npm install @lemonsqueezy/lemonsqueezy.js`

**`getUsageStats` query:**
- Authenticated query (same pattern as `convex/orgs/get.ts:getMyOrg`)
- Get user identity, look up user record by workosUserId, get orgId
- Throw ConvexError if not authenticated or no org
- Count customers: query `customers` table by `by_org` index
- Count staff: query `users` table by `by_org` index, filter `role === "staff"` and `deletedAt === undefined`
- Count clients: query `users` table by `by_org` index, filter `role === "client"` and `deletedAt === undefined`
- Count pending staff invitations: query `pendingInvitations` by `by_org` index, filter `role === "staff"`
- Count pending client invitations: query `pendingInvitations` by `by_org` index, filter `role === "client"`
- Get org for limits (maxCustomers, maxStaff, maxClients)
- Return structured object:
  ```
  {
    plan: {
      name: string,        // from getPlanName(org.planId)
      status: string,      // org.subscriptionStatus || "inactive"
      planId: string | undefined,
    },
    usage: {
      customers: { count: number, max: number },
      staff: { count: number, max: number },      // count includes pending
      clients: { count: number, max: number },     // count includes pending
    },
  }
  ```
- Import `getPlanName` from `../lemonsqueezy/plans` -- NOTE: this file is created by Plan 03-01 (same wave). **Wiring approach:** If Plan 01 has already executed, import directly from `../lemonsqueezy/plans`. If Plan 01 hasn't executed yet, define a temporary inline `getPlanName(planId: string | undefined): string` helper that returns "Free" for undefined, "Pro"/"Business" based on simple variant matching. Add a `// TODO: replace with import from ../lemonsqueezy/plans once Plan 01 completes` comment. The executor should check if the file exists and use the import if available. This is pragmatic parallel execution -- no additional consolidation task needed since the inline helper has identical behavior.

**`getBillingInfo` query:**
- Authenticated query, admin-only (check role === "admin")
- Returns org billing fields: subscriptionId, subscriptionStatus, planId, trialEndsAt, endsAt, plus org name and workosOrgId
- Also return `isTrialing: boolean` computed as `subscriptionStatus === "active" && trialEndsAt && trialEndsAt > Date.now()`
- Also return `trialDaysRemaining: number | null` computed from trialEndsAt if trialing
- Used by billing page to determine current state (show upgrade vs manage subscription vs trial info)
  </action>
  <verify>
Run `npx convex dev --once` to verify compilation. Check that getUsageStats counts include pending invitations. Check getBillingInfo enforces admin role.
  </verify>
  <done>
getUsageStats returns real counts (customers, staff+pending, clients+pending) against org limits. getBillingInfo returns subscription state for billing page. Both enforce authentication; getBillingInfo additionally requires admin role.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create checkout and cancel subscription actions</name>
  <files>convex/billing/actions.ts</files>
  <action>
Create `convex/billing/actions.ts`:

This file needs `"use node"` directive at the top (same pattern as `convex/invitations/send.ts`) because it imports the Lemon Squeezy SDK which requires Node.js runtime.

**`createCheckoutUrl` action:**
- Args: `variantId: v.string()` (the Lemon Squeezy variant ID for the plan)
- Get authenticated user, look up user record via internal query
- Verify user is admin role
- Get org details via internal query
- Build checkout URL via string construction (the frontend opens it via Lemon.js overlay with `LemonSqueezy.Url.Open()`):
  ```
  const storeSlug = process.env.LEMONSQUEEZY_STORE_SLUG;
  if (!storeSlug) throw new ConvexError("LEMONSQUEEZY_STORE_SLUG not configured");
  const checkoutUrl = new URL(`https://${storeSlug}.lemonsqueezy.com/checkout/buy/${variantId}`);
  checkoutUrl.searchParams.set("checkout[email]", userRecord.email);
  checkoutUrl.searchParams.set("checkout[name]", org.name);
  checkoutUrl.searchParams.set("checkout[custom][org_convex_id]", org._id);
  ```
- Return `{ checkoutUrl: string }` for the frontend to open via Lemon.js overlay

**`cancelSubscription` action:**
- Args: none (cancels current org's subscription)
- Get authenticated user, verify admin role
- Get org via internal query, verify org has subscriptionId
- Initialize Lemon Squeezy SDK: `lemonSqueezySetup({ apiKey: process.env.LEMONSQUEEZY_API_KEY! })`
- Call `cancelSubscription(org.subscriptionId)` from `@lemonsqueezy/lemonsqueezy.js`
- If error, throw ConvexError with message
- Return `{ success: true, endsAt: result.data.data.attributes.ends_at }` so UI can show when access expires
- NOTE: The actual status update happens via webhook (subscription_cancelled event), not here. This action just initiates cancellation with Lemon Squeezy.

**`getCustomerPortalUrl` action:**
- Args: none (gets portal URL for current org's subscription)
- Get authenticated user, verify admin role
- Get org via internal query, verify org has subscriptionId
- Initialize Lemon Squeezy SDK: `lemonSqueezySetup({ apiKey: process.env.LEMONSQUEEZY_API_KEY! })`
- Call `getCustomer(org.lemonSqueezyCustomerId)` from `@lemonsqueezy/lemonsqueezy.js` to get the customer object
- Extract `customer_portal.url` from customer attributes -- this is a pre-signed URL to the Lemon Squeezy customer portal where users can view invoices, receipts, and manage payment methods
- If org doesn't have a lemonSqueezyCustomerId yet, return `{ portalUrl: null }` (user hasn't subscribed yet, no invoices to show)
- Return `{ portalUrl: string | null }`
- NOTE: The customer ID should be stored on the org during subscription_created webhook processing. Update Plan 03-01 sync.ts to also store `lemonSqueezyCustomerId` from the subscription attributes.customer_id field.

All three actions need internal queries to get user records and org. Reuse `internal.invitations.internal.getUserRecord` for user lookup, and `internal.orgs.get.getMyOrgInternal` for org lookup.
  </action>
  <verify>
Run `npx convex dev --once` to verify compilation. Check that:
1. File has "use node" directive
2. createCheckoutUrl builds URL with LEMONSQUEEZY_STORE_SLUG env var, pre-filled email, name, and org_convex_id custom data
3. cancelSubscription uses official SDK's cancelSubscription function
4. getCustomerPortalUrl retrieves customer portal URL from LS SDK
5. All three actions verify admin role before proceeding
  </verify>
  <done>
createCheckoutUrl returns a pre-filled Lemon Squeezy checkout URL for a given variant. cancelSubscription calls Lemon Squeezy API to initiate cancellation. getCustomerPortalUrl returns pre-signed customer portal URL for invoice viewing. All three enforce admin-only access. Checkout URL includes custom data (org_convex_id) for webhook correlation.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` succeeds
2. `npm install @lemonsqueezy/lemonsqueezy.js` added to dependencies
3. getUsageStats returns usage with pending invitations counted
4. getBillingInfo includes isTrialing and trialDaysRemaining fields
5. createCheckoutUrl includes org_convex_id in custom data for webhook correlation
6. cancelSubscription uses official SDK (not raw fetch)
7. getCustomerPortalUrl returns portal URL from LS SDK (or null if no subscription)
8. All functions enforce authentication and admin authorization
</verification>

<success_criteria>
- Billing queries return real usage data and trial info from Convex database
- Checkout URL action builds pre-filled Lemon Squeezy URL with org correlation data
- Cancel action calls Lemon Squeezy API and returns end date
- Customer portal URL action returns pre-signed URL for invoice viewing
- All operations enforce admin-only access
- SDK installed and "use node" directive present for actions file
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing/03-02-SUMMARY.md`
</output>
