---
phase: 03-billing
plan: 06
type: execute
wave: 3
depends_on: ["03-02", "03-04"]
files_modified:
  - src/components/team/invite-dialog.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Inviting staff when at maxStaff limit shows CapReachedBanner with Upgrade Plan link to /billing"
    - "Inviting client when at maxClients limit shows CapReachedBanner with Upgrade Plan link to /billing"
    - "Submit button is disabled when the selected role is at its cap limit (proactive check)"
    - "Upgrade prompt UX is consistent between InviteDialog and customer creation dialog"
  artifacts:
    - path: "src/components/team/invite-dialog.tsx"
      provides: "Invite dialog with inline CapReachedBanner upgrade prompt"
      contains: "CapReachedBanner"
  key_links:
    - from: "src/components/team/invite-dialog.tsx"
      to: "convex/billing/queries.ts"
      via: "useQuery(api.billing.queries.getUsageStats)"
      pattern: "useQuery.*getUsageStats"
    - from: "src/components/team/invite-dialog.tsx"
      to: "src/components/billing/CapReachedBanner.tsx"
      via: "import { CapReachedBanner }"
      pattern: "import.*CapReachedBanner"
---

<objective>
Add CapReachedBanner upgrade prompt to the team InviteDialog for staff and client cap enforcement.

Purpose: Close 3 verification gaps where the InviteDialog shows only error text when plan limits are reached, instead of the CapReachedBanner component with a visual upgrade prompt and link to /billing. This makes the InviteDialog consistent with the customer creation dialog pattern.

Output: Updated invite-dialog.tsx with proactive limit detection and inline upgrade prompt.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing/03-VERIFICATION.md

# Key reference files
@src/components/team/invite-dialog.tsx
@src/components/billing/CapReachedBanner.tsx
@convex/billing/queries.ts
@src/routes/_authenticated/customers.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CapReachedBanner and proactive limit check to InviteDialog</name>
  <files>src/components/team/invite-dialog.tsx</files>
  <action>
    Update the InviteDialog component to include CapReachedBanner and proactive limit detection.
    Follow the exact pattern used in src/routes/_authenticated/customers.tsx for cap enforcement UX.

    1. **Add imports:**
       - Import `CapReachedBanner` from `@/components/billing/CapReachedBanner`
       - The `api` import already exists (line 4), no changes needed there

    2. **Add usage stats query:**
       - Add `const usageStats = useQuery(api.billing.queries.getUsageStats);` alongside the existing `customers` query (near line 39)

    3. **Compute limit state:**
       - After the query, derive the current limit status based on the selected `role`:
       ```tsx
       const isAtStaffLimit = usageStats
         ? usageStats.usage.staff.count >= usageStats.usage.staff.max
         : false;
       const isAtClientLimit = usageStats
         ? usageStats.usage.clients.count >= usageStats.usage.clients.max
         : false;
       const isAtLimit = role === 'staff' ? isAtStaffLimit : isAtClientLimit;
       ```

    4. **Detect limit error from backend response:**
       - Add a `limitError` boolean state: `const [limitError, setLimitError] = useState(false);`
       - In the catch block, detect if the error message contains "limit reached":
       ```tsx
       const isLimitError = message.includes('limit reached');
       setLimitError(isLimitError);
       ```
       - Reset `limitError` in `resetForm()`: add `setLimitError(false);`

    5. **Add CapReachedBanner below the error Alert:**
       - Inside the `<div className="grid gap-4 py-4">` section, after the error Alert block (line 107) and before the email field, add:
       ```tsx
       {(isAtLimit || limitError) && usageStats && (
         <CapReachedBanner
           resourceType={role === 'staff' ? 'staff' : 'clients'}
           currentCount={
             role === 'staff'
               ? usageStats.usage.staff.count
               : usageStats.usage.clients.count
           }
           maxCount={
             role === 'staff'
               ? usageStats.usage.staff.max
               : usageStats.usage.clients.max
           }
         />
       )}
       ```

    6. **Disable submit button when at limit:**
       - Update the submit Button's `disabled` prop from `disabled={isSubmitting}` to:
       ```tsx
       disabled={isSubmitting || isAtLimit}
       ```

    **Important:** Do NOT use `getCustomerUsage` query (that's for customers). Use `getUsageStats` from `convex/billing/queries.ts` which returns `{ usage: { staff: {count, max}, clients: {count, max}, customers: {count, max} } }`.

    **Re-check when role changes:** Because `isAtLimit` depends on `role` state, switching roles will automatically recalculate whether the current role is at limit. The `usageStats` query runs once and contains both staff and client counts.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` from the project root — no type errors in invite-dialog.tsx
    2. Run `npx eslint src/components/team/invite-dialog.tsx` — no lint errors
    3. Visually confirm in the code:
       - CapReachedBanner is imported
       - useQuery for getUsageStats is present
       - CapReachedBanner renders when isAtLimit or limitError is true
       - Submit button disabled when isAtLimit
       - limitError state is set in catch block and reset in resetForm
  </verify>
  <done>
    - InviteDialog shows CapReachedBanner with "Upgrade Plan" link to /billing when staff limit reached
    - InviteDialog shows CapReachedBanner with "Upgrade Plan" link to /billing when client limit reached
    - Submit button is proactively disabled when selected role is at its cap limit
    - limitError flag triggers CapReachedBanner even if proactive check missed (race condition safety)
    - UX pattern matches customer creation dialog exactly
  </done>
</task>

</tasks>

<verification>
After task completion, verify all 3 gaps from VERIFICATION.md are closed:

1. **Gap 1 (Truth #23):** Open InviteDialog, select "Staff" role when staff count >= maxStaff. CapReachedBanner should appear with "Upgrade Plan" button linking to /billing. Submit button should be disabled.

2. **Gap 2 (Truth #24):** Open InviteDialog, select "Client" role when client count >= maxClients. CapReachedBanner should appear with "Upgrade Plan" button linking to /billing. Submit button should be disabled.

3. **Gap 3 (Truth #26):** Compare InviteDialog upgrade prompt with customer creation dialog. Both should use CapReachedBanner component with identical visual styling and link to /billing.

Type check: `npx tsc --noEmit` passes with no errors.
</verification>

<success_criteria>
- CapReachedBanner imported and rendered in InviteDialog for both staff and client roles
- Submit button proactively disabled when at limit (before any backend error)
- Backend limit error also triggers CapReachedBanner display (fallback)
- Link to /billing present via CapReachedBanner's built-in Upgrade Plan button
- TypeScript compiles without errors
- UX consistency between InviteDialog and customer creation dialog
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing/03-06-SUMMARY.md`
</output>
