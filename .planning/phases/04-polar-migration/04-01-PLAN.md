---
phase: 04-polar-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex/convex.config.ts
  - convex/polar.ts
  - convex/http.ts
  - convex/schema.ts
  - convex/billing/actions.ts
  - convex/billing/queries.ts
  - convex/lemonsqueezy/plans.ts
  - convex/lemonsqueezy/signature.ts
  - convex/lemonsqueezy/sync.ts
  - convex/lemonsqueezy/webhook.ts
autonomous: true
user_setup:
  - service: polar
    why: "Billing integration and webhook verification"
    env_vars:
      - name: POLAR_ORGANIZATION_TOKEN
        source: "Polar Dashboard -> Settings -> API Keys"
      - name: POLAR_WEBHOOK_SECRET
        source: "Polar Dashboard -> Settings -> Webhooks"
      - name: POLAR_SERVER
        source: "Set to sandbox or production"
    dashboard_config:
      - task: "Create products for each plan and copy product IDs"
        location: "Polar Dashboard -> Products"
      - task: "Configure webhook endpoint"
        location: "Polar Dashboard -> Webhooks (https://<deployment>.convex.site/polar/events)"

must_haves:
  truths:
    - "Billing webhooks are handled by Polar at /polar/events"
    - "Subscription state is read from Polar (no Lemon Squeezy APIs used)"
    - "Lemon Squeezy billing code and SDK are removed from the backend"
  artifacts:
    - path: "convex/convex.config.ts"
      provides: "Convex app uses Polar component"
      contains: "app.use(polar)"
    - path: "convex/polar.ts"
      provides: "Polar client configuration and API exports"
      exports: ["getCurrentSubscription", "generateCheckoutLink", "generateCustomerPortalUrl"]
    - path: "convex/http.ts"
      provides: "Polar webhook route registration"
      contains: "/polar/events"
  key_links:
    - from: "convex/http.ts"
      to: "convex/polar.ts"
      via: "polar.registerRoutes"
      pattern: "registerRoutes\(http"
    - from: "convex/billing/actions.ts"
      to: "convex/polar.ts"
      via: "polar.api checkout/portal helpers"
      pattern: "polar\.api\(\)"
---

<objective>
Replace Lemon Squeezy billing backend with Polar component integration.

Purpose: Ensure subscriptions, checkout, and webhooks run through Polar for the Convex backend.
Output: Polar-backed billing actions/queries and webhook routes.
</objective>

<execution_context>
@/Users/boss/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/boss/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polar-migration/04-DISCOVERY.md
@convex/http.ts
@convex/billing/actions.ts
@convex/billing/queries.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Swap Lemon Squeezy SDK for Polar component</name>
  <files>package.json, convex/convex.config.ts, convex/polar.ts, convex/http.ts, convex/lemonsqueezy/webhook.ts, convex/lemonsqueezy/signature.ts, convex/lemonsqueezy/sync.ts, convex/lemonsqueezy/plans.ts</files>
  <action>
  - Remove the Lemon Squeezy SDK dependency and add `@convex-dev/polar`.
  - Create `convex/convex.config.ts` with `defineApp()` and `app.use(polar)` per Polar component docs.
  - Add `convex/polar.ts` to configure product keys -> Polar product IDs and export Polar APIs.
  - Register Polar webhook routes in `convex/http.ts` at `/polar/events` and remove Lemon Squeezy webhook wiring.
  - Delete Lemon Squeezy integration files under `convex/lemonsqueezy/` and ensure no imports remain.
  </action>
  <verify>npm run lint</verify>
  <done>Polar component is configured, and Lemon Squeezy backend code is removed without lint errors.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate billing actions and schema to Polar</name>
  <files>convex/billing/actions.ts, convex/billing/queries.ts, convex/schema.ts</files>
  <action>
  - Replace Lemon Squeezy calls in billing actions/queries with `polar.api()` equivalents.
  - Update schema fields on orgs to remove Lemon Squeezy-specific IDs and store any required Polar identifiers (if needed for UI).
  - Update plan/limit resolution to use Polar product keys and subscription status (`active` or `trialing`).
  </action>
  <verify>npm run lint</verify>
  <done>Billing queries/actions read subscription status from Polar and compile without Lemon Squeezy references.</done>
</task>

</tasks>

<verification>
- Lint passes after backend migration.
- Billing actions and queries compile against Polar APIs.
</verification>

<success_criteria>

- Polar webhook route is registered and Lemon Squeezy routes are removed.
- Backend billing uses Polar APIs for checkout/portal/subscription state.
- No Lemon Squeezy backend dependencies remain.
  </success_criteria>

<output>
After completion, create `.planning/phases/04-polar-migration/04-01-SUMMARY.md`
</output>
