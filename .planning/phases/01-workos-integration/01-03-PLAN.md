---
phase: 01-workos-integration
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - convex/workos/updateOrg.ts
  - convex/orgs/get.ts
  - convex/orgs/update.ts
  - src/routes/_authenticated/settings.tsx
autonomous: false

must_haves:
  truths:
    - "Settings page shows real org name from Convex"
    - "Settings page shows billing email from Convex"
    - "User can edit org name and billing email"
    - "Save syncs changes to WorkOS and Convex"
  artifacts:
    - path: "convex/workos/updateOrg.ts"
      provides: "WorkOS org update action"
      exports: ["updateOrganization"]
    - path: "convex/orgs/update.ts"
      provides: "Internal mutation for syncing org updates"
      exports: ["syncOrgUpdate"]
    - path: "src/routes/_authenticated/settings.tsx"
      provides: "Settings page with live org data"
      contains: "useQuery"
  key_links:
    - from: "src/routes/_authenticated/settings.tsx"
      to: "convex/orgs/get.ts"
      via: "useQuery(api.orgs.get.getMyOrg)"
      pattern: "getMyOrg"
    - from: "src/routes/_authenticated/settings.tsx"
      to: "convex/workos/updateOrg.ts"
      via: "useAction(api.workos.updateOrg.updateOrganization)"
      pattern: "updateOrganization"
---

<objective>
Wire settings page to show and update real org data

Purpose: Users can view and update their organization settings. Changes sync to both WorkOS and Convex for data consistency.

Output: Settings page that loads real org data, allows editing name and billing email, and syncs changes to WorkOS.

Note: This plan extends the existing `convex/orgs/get.ts` file (adding an internal query) and creates new files for update functionality.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-workos-integration/01-CONTEXT.md
@.planning/phases/01-workos-integration/01-RESEARCH.md

# Prior plan summary
@.planning/phases/01-workos-integration/01-01-SUMMARY.md

# Files to modify
@convex/orgs/get.ts
@src/routes/_authenticated/settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkOS update org action</name>
  <files>convex/workos/updateOrg.ts, convex/orgs/get.ts, convex/orgs/update.ts</files>
  <action>
1. Create `convex/workos/updateOrg.ts`:

```typescript
"use node";
import { action } from "../_generated/server";
import { internal } from "../_generated/api";
import { WorkOS } from "@workos-inc/node";
import { v, ConvexError } from "convex/values";

export const updateOrganization = action({
  args: {
    name: v.optional(v.string()),
    billingEmail: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // Verify authentication
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new ConvexError("Not authenticated");
    }

    // Get user's org from Convex
    const userOrg = await ctx.runQuery(internal.orgs.get.getMyOrgInternal, {
      workosUserId: identity.subject,
    });

    if (!userOrg) {
      throw new ConvexError("No organization found");
    }

    // Initialize WorkOS
    const workos = new WorkOS(process.env.WORKOS_API_KEY!);

    try {
      // Build update payload
      const updateData: any = {
        organization: userOrg.workosOrgId,
      };

      if (args.name) {
        updateData.name = args.name;
      }

      if (args.billingEmail !== undefined) {
        updateData.metadata = {
          billingEmail: args.billingEmail,
        };
      }

      // Update in WorkOS
      await workos.organizations.updateOrganization(updateData);

      // Sync to Convex
      await ctx.runMutation(internal.orgs.update.syncOrgUpdate, {
        orgId: userOrg._id,
        name: args.name,
        billingEmail: args.billingEmail,
      });

      return { success: true };
    } catch (error) {
      throw new ConvexError(
        error instanceof Error
          ? error.message
          : "Failed to update organization. Please try again."
      );
    }
  },
});
```

2. Extend `convex/orgs/get.ts` with internal query:

Add this after existing exports:
```typescript
import { internalQuery } from "../_generated/server";

export const getMyOrgInternal = internalQuery({
  args: {
    workosUserId: v.string(),
  },
  handler: async (ctx, args) => {
    const userRecord = await ctx.db
      .query("users")
      .withIndex("by_workos_user_id", (q) => q.eq("workosUserId", args.workosUserId))
      .first();

    if (!userRecord?.orgId) {
      return null;
    }

    const org = await ctx.db.get(userRecord.orgId);
    return org;
  },
});
```

Add import for v at top if not present:
```typescript
import { v } from "convex/values";
```

3. Create `convex/orgs/update.ts`:

```typescript
import { v } from "convex/values";
import { internalMutation } from "../_generated/server";
import type { Id } from "../_generated/dataModel";

export const syncOrgUpdate = internalMutation({
  args: {
    orgId: v.id("orgs"),
    name: v.optional(v.string()),
    billingEmail: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const updates: Record<string, any> = {
      updatedAt: Date.now(),
    };

    if (args.name !== undefined) {
      updates.name = args.name;
    }

    if (args.billingEmail !== undefined) {
      updates.billingEmail = args.billingEmail;
    }

    await ctx.db.patch(args.orgId, updates);
  },
});
```
  </action>
  <verify>
- `ls convex/workos/updateOrg.ts` exists
- `ls convex/orgs/update.ts` exists
- `grep getMyOrgInternal convex/orgs/get.ts` shows internal query
- `npx convex dev --once` completes without errors
  </verify>
  <done>
- convex/workos/updateOrg.ts exports updateOrganization action
- convex/orgs/get.ts exports getMyOrgInternal internal query
- convex/orgs/update.ts exports syncOrgUpdate internal mutation
- All types pass Convex validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire settings page to live org data</name>
  <files>src/routes/_authenticated/settings.tsx</files>
  <action>
Update settings page to load and save real org data:

1. Add imports:
```typescript
import { useQuery, useAction } from 'convex/react';
import { api } from '../../../convex/_generated/api';
import { useState, useEffect } from 'react';
import { Loader2 } from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';
```

2. Add state and data fetching in component:
```typescript
function SettingsPage() {
  const org = useQuery(api.orgs.get.getMyOrg);
  const updateOrg = useAction(api.workos.updateOrg.updateOrganization);

  const [orgName, setOrgName] = useState('');
  const [billingEmail, setBillingEmail] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const [saveError, setSaveError] = useState<string | null>(null);
  const [saveSuccess, setSaveSuccess] = useState(false);

  // Initialize form when org loads
  useEffect(() => {
    if (org) {
      setOrgName(org.name);
      setBillingEmail(org.billingEmail || '');
    }
  }, [org]);

  // Check if form has changes
  const hasChanges = org && (
    orgName !== org.name ||
    billingEmail !== (org.billingEmail || '')
  );

  const handleSave = async () => {
    if (!hasChanges) return;

    setIsSaving(true);
    setSaveError(null);
    setSaveSuccess(false);

    try {
      await updateOrg({
        name: orgName !== org?.name ? orgName : undefined,
        billingEmail: billingEmail !== org?.billingEmail ? billingEmail : undefined,
      });
      setSaveSuccess(true);
      setTimeout(() => setSaveSuccess(false), 3000);
    } catch (err) {
      setSaveError(
        err instanceof Error ? err.message : 'Failed to save changes'
      );
    } finally {
      setIsSaving(false);
    }
  };
  // ... rest of component
}
```

3. Update Organization card content:
- Show loading skeleton if org is undefined
- Bind org name input to orgName state with onChange
- Add billing email field after org name (same pattern)
- Remove the slug field (not needed)
- Update Save button:
  - Disabled when !hasChanges or isSaving
  - Show spinner when saving
  - onClick calls handleSave

4. Add feedback after the Save button:
```typescript
{saveError && (
  <Alert variant="destructive" className="mt-4">
    <AlertDescription>{saveError}</AlertDescription>
  </Alert>
)}
{saveSuccess && (
  <Alert className="mt-4">
    <AlertDescription>Changes saved successfully!</AlertDescription>
  </Alert>
)}
```

5. Show loading state:
```typescript
if (org === undefined) {
  return (
    <div className="flex items-center justify-center py-12">
      <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
    </div>
  );
}
```

Keep the Notifications and Security cards as-is (they are placeholder UI for future phases).
  </action>
  <verify>
- `grep useQuery src/routes/_authenticated/settings.tsx` shows data fetching
- `grep useAction src/routes/_authenticated/settings.tsx` shows update action
- `grep billingEmail src/routes/_authenticated/settings.tsx` shows billing email field
- `grep hasChanges src/routes/_authenticated/settings.tsx` shows change detection
- `npx tsc --noEmit` passes
  </verify>
  <done>
- Settings page fetches org data via useQuery
- Form fields bound to state, initialized from org data
- Billing email field added to Organization card
- Save button triggers updateOrganization action
- Save button disabled when no changes
- Error and success feedback displayed
- Loading state shows spinner
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete WorkOS org integration:
    1. WorkOS SDK installed
    2. Org creation action with WorkOS API
    3. Onboarding collects billing email
    4. Settings page shows/updates real org data
  </what-built>
  <how-to-verify>
    NOTE: Before testing, ensure WORKOS_API_KEY is set in Convex:
    `npx convex env set WORKOS_API_KEY sk_test_YOUR_KEY`

    1. Start dev server: `npm run dev`
    2. Sign out if logged in, then sign in fresh
    3. On onboarding page:
       - Verify org name AND billing email fields exist
       - Billing email should be pre-filled with your login email
       - Enter org name and billing email, click Create
       - Should redirect to dashboard (no mock ID visible anywhere)
    4. Navigate to Settings:
       - Org name should show what you entered
       - Billing email should show what you entered
       - Change org name, click Save
       - Should show "Changes saved" feedback
       - Refresh page - changes should persist

    If WorkOS API key is not set, you'll see an error on org creation - that's expected.
  </how-to-verify>
  <resume-signal>Type "approved" if flow works, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Update action exists: `ls convex/workos/updateOrg.ts`
2. Internal helpers exist: `grep -l syncOrgUpdate convex/orgs/update.ts`
3. Settings wired: `grep -E "useQuery|useAction" src/routes/_authenticated/settings.tsx`
4. Types valid: `npx tsc --noEmit` passes
5. Manual test: Settings shows real org data and saves changes
</verification>

<success_criteria>
- convex/workos/updateOrg.ts exports updateOrganization action
- convex/orgs/update.ts exports syncOrgUpdate mutation
- Settings page loads org data from Convex
- Settings page shows org name and billing email
- Save button syncs changes to WorkOS and Convex
- User feedback on save success/error
- Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/01-workos-integration/01-03-SUMMARY.md`
</output>
