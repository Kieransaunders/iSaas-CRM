---
phase: 01-workos-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex/schema.ts
  - convex/workos/createOrg.ts
autonomous: true
user_setup:
  - service: workos
    why: "Organization management API"
    env_vars:
      - name: WORKOS_API_KEY
        source: "WorkOS Dashboard -> API Keys (sk_test_... or sk_live_...)"
    dashboard_config: []

must_haves:
  truths:
    - "@workos-inc/node package is installed"
    - "Convex action exists that calls WorkOS createOrganization API"
    - "Convex action creates organization membership for current user"
    - "Schema includes billingEmail field on orgs table"
  artifacts:
    - path: "convex/workos/createOrg.ts"
      provides: "WorkOS org creation action"
      exports: ["createOrganization"]
    - path: "convex/schema.ts"
      provides: "Updated schema with billingEmail"
      contains: "billingEmail"
  key_links:
    - from: "convex/workos/createOrg.ts"
      to: "WorkOS API"
      via: "workos.organizations.createOrganization"
      pattern: "createOrganization"
    - from: "convex/workos/createOrg.ts"
      to: "WorkOS API"
      via: "workos.userManagement.createOrganizationMembership"
      pattern: "createOrganizationMembership"
---

<objective>
Install WorkOS Node SDK and create Convex action for real org creation

Purpose: Replace mock org IDs with real WorkOS API integration. This is the foundation - onboarding and settings depend on this action existing.

Output: Working Convex action that creates organizations in WorkOS, adds user as admin member, and stores org data in Convex.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-workos-integration/01-RESEARCH.md

# Existing files to modify/reference
@convex/schema.ts
@convex/orgs/create.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install WorkOS SDK and update schema</name>
  <files>package.json, convex/schema.ts</files>
  <action>
1. Install @workos-inc/node@8:
   ```bash
   npm install @workos-inc/node@8
   ```

2. Update convex/schema.ts to add billingEmail field to orgs table:
   - Add `billingEmail: v.optional(v.string())` after the `name` field
   - This stores the billing email (also kept in WorkOS metadata for sync)

Do NOT modify any other fields in the schema.
  </action>
  <verify>
- `npm ls @workos-inc/node` shows version 8.x installed
- `grep billingEmail convex/schema.ts` shows the new field
  </verify>
  <done>
- @workos-inc/node@8 in package.json dependencies
- billingEmail field exists in orgs table schema
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkOS org creation action</name>
  <files>convex/workos/createOrg.ts</files>
  <action>
Create new file `convex/workos/createOrg.ts` with:

1. Add "use node"; directive at top (required for WorkOS SDK)

2. Import dependencies:
   - action, internalMutation from "../_generated/server"
   - internal from "../_generated/api"
   - WorkOS from "@workos-inc/node"
   - v, ConvexError from "convex/values"

3. Create `createOrganization` action:
   - Args: name (string), billingEmail (string)
   - Get authenticated user identity, throw if not authenticated
   - Extract workosUserId from identity.subject
   - Initialize WorkOS client with process.env.WORKOS_API_KEY
   - Call workos.organizations.createOrganization with:
     - name: args.name
     - metadata: { billingEmail: args.billingEmail }
   - Call workos.userManagement.createOrganizationMembership with:
     - userId: workosUserId
     - organizationId: org.id
     - roleSlug: "admin"
   - Call internal mutation to store org in Convex (see storeOrg below)
   - Return { orgId: convexOrgId, workosOrgId: org.id }

4. Create `storeOrg` internalMutation:
   - Args: workosOrgId (string), name (string), billingEmail (string), workosUserId (string)
   - Insert into orgs table with:
     - workosOrgId, name, billingEmail
     - subscriptionStatus: "inactive"
     - planId: "free"
     - maxCustomers: 3, maxStaff: 2, maxClients: 10
     - createdAt/updatedAt: Date.now()
   - Find existing user by workosUserId
   - If exists: patch with orgId, role: "admin"
   - If not exists: insert new user with orgId, role: "admin", email from args
   - Return orgId

IMPORTANT: Wrap WorkOS API calls in try/catch. On error, throw ConvexError with user-friendly message that includes "Please try again" for retry UX.
  </action>
  <verify>
- File exists at convex/workos/createOrg.ts
- `npx convex dev --once` completes without type errors
- Grep shows "use node" directive, createOrganization export, createOrganizationMembership call
  </verify>
  <done>
- convex/workos/createOrg.ts exports createOrganization action
- Action calls WorkOS createOrganization API
- Action calls WorkOS createOrganizationMembership API
- Action stores org in Convex via internal mutation
- Errors are caught and re-thrown with retry-friendly message
  </done>
</task>

</tasks>

<verification>
1. Package installed: `npm ls @workos-inc/node` shows 8.x
2. Schema updated: `grep -n billingEmail convex/schema.ts`
3. Action exists: `ls convex/workos/createOrg.ts`
4. Types valid: `npx convex dev --once` succeeds
5. Exports correct: `grep -E "export const (createOrganization|storeOrg)" convex/workos/createOrg.ts`
</verification>

<success_criteria>
- @workos-inc/node@8 installed
- convex/schema.ts has billingEmail field on orgs
- convex/workos/createOrg.ts exists with createOrganization action
- Action uses "use node" directive
- Action calls both WorkOS createOrganization and createOrganizationMembership
- Action has error handling with retry-friendly messages
- `npx convex dev --once` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-workos-integration/01-01-SUMMARY.md`
</output>
