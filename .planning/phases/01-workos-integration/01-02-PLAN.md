---
phase: 01-workos-integration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/routes/onboarding.tsx
autonomous: true

must_haves:
  truths:
    - "Onboarding form collects org name and billing email"
    - "Form submission calls WorkOS org creation action"
    - "Failed submission shows error with retry button"
    - "Successful submission redirects to dashboard"
  artifacts:
    - path: "src/routes/onboarding.tsx"
      provides: "Onboarding form with billing email and WorkOS integration"
      contains: "billingEmail"
  key_links:
    - from: "src/routes/onboarding.tsx"
      to: "convex/workos/createOrg.ts"
      via: "useAction + api.workos.createOrg.createOrganization"
      pattern: "createOrganization"
---

<objective>
Wire onboarding form to real WorkOS org creation

Purpose: Users can create real organizations during signup with name and billing email. Replaces mock org ID generation with actual WorkOS API call.

Output: Onboarding page that collects org name + billing email, calls the WorkOS action, handles errors with retry, and redirects on success.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-workos-integration/01-CONTEXT.md

# Prior plan summary
@.planning/phases/01-workos-integration/01-01-SUMMARY.md

# File to modify
@src/routes/onboarding.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billing email field to onboarding</name>
  <files>src/routes/onboarding.tsx</files>
  <action>
Update the onboarding form to collect billing email:

1. Add state for billing email with optional chaining for safety:
   ```typescript
   const [billingEmail, setBillingEmail] = useState(user?.email || '');
   ```
   Note: Use optional chaining (`user?.email`) to handle cases where user object may be undefined or email property may be missing.

2. Add billing email input field after org name field:
   - Label: "Billing Email"
   - Input type="email", required
   - Placeholder: "billing@yourcompany.com"
   - Helper text: "Invoices and billing notifications will be sent here"

3. Update form validation to require both fields:
   - Check orgName.trim() AND billingEmail.trim()
   - Basic email format validation (contains @)
  </action>
  <verify>
- Grep shows billingEmail state in onboarding.tsx
- Grep shows `user?.email` with optional chaining
- Grep shows email input with type="email"
- Form has two required fields visible
  </verify>
  <done>
- Billing email state exists and is pre-populated from user?.email (with optional chaining)
- Billing email input field renders with label and helper text
- Form validates both org name and billing email before submission
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire form to WorkOS action with retry</name>
  <files>src/routes/onboarding.tsx</files>
  <action>
Replace mock org ID with real WorkOS action call:

1. Import useAction from convex/react:
   ```typescript
   import { useQuery, useAction } from 'convex/react';
   ```

2. Replace useMutation with useAction for org creation:
   ```typescript
   const createOrg = useAction(api.workos.createOrg.createOrganization);
   ```
   Remove the old `createOrgInConvex` mutation reference.

3. Update handleCreateOrg to call the action:
   ```typescript
   const handleCreateOrg = async (e: React.FormEvent) => {
     e.preventDefault();
     if (!orgName.trim() || !billingEmail.trim()) return;

     setError(null);
     setIsLoading(true);

     try {
       await createOrg({
         name: orgName.trim(),
         billingEmail: billingEmail.trim(),
       });

       setIsSuccess(true);
       setTimeout(() => {
         navigate({ to: '/dashboard' });
       }, 1500);
     } catch (err) {
       setError(
         err instanceof Error
           ? err.message
           : 'Failed to create organization. Please try again.'
       );
     } finally {
       setIsLoading(false);
     }
   };
   ```

4. Update error display to include prominent retry:
   - Show error message in Alert
   - Add "Try Again" button that re-triggers handleCreateOrg
   - Button should be disabled while loading

5. Remove the mock org ID generation code entirely:
   - Delete: `const mockWorkosOrgId = org_${Date.now()}...`

IMPORTANT: Keep the existing success state and redirect logic intact.
  </action>
  <verify>
- `grep -n "useAction" src/routes/onboarding.tsx` shows import and usage
- `grep -n "mockWorkosOrgId" src/routes/onboarding.tsx` returns nothing (removed)
- `grep -n "createOrganization" src/routes/onboarding.tsx` shows action call
- `grep -n "Try Again" src/routes/onboarding.tsx` shows retry button
  </verify>
  <done>
- Form calls api.workos.createOrg.createOrganization action
- Mock org ID generation is removed
- Error state shows message with retry button
- Success state redirects to dashboard
- Loading states disable form and button appropriately
  </done>
</task>

</tasks>

<verification>
1. Form fields: Run app, navigate to /onboarding, verify both org name and billing email fields exist
2. No mock ID: `grep mockWorkosOrgId src/routes/onboarding.tsx` returns empty
3. Action wired: `grep "api.workos.createOrg" src/routes/onboarding.tsx` shows import
4. Retry exists: `grep -i "try again\|retry" src/routes/onboarding.tsx` shows retry UI
5. Types valid: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Onboarding form has org name AND billing email fields
- Billing email pre-populated from user?.email (with optional chaining)
- Form submission calls WorkOS action (not mutation with mock ID)
- Error display includes clear retry option
- Success redirects to dashboard
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-workos-integration/01-02-SUMMARY.md`
</output>
